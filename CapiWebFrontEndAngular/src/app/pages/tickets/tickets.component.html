<div class="page" *ngIf="authStatus === 'ready'; else loadingOrRedirect">
    <header class="header">
        <div>
            <h1>üìÑ Gestor de Tickets</h1>
            <p class="subtitle" *ngIf="user">Bienvenido, {{ user.username }}</p>
        </div>
        <div class="user-section">
            <div class="user-avatar" [class.active]="showUserMenu" (click)="toggleUserMenu()">
                {{ user?.username?.substring(0,2)?.toUpperCase() || 'üë§' }}
                <div class="user-dropdown" *ngIf="showUserMenu" (click)="$event.stopPropagation()">
                    <div class="dropdown-item" (click)="openEditModal()">Editar datos</div>
                    <div class="dropdown-item" (click)="handleLogout()">Cerrar sesi√≥n</div>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <section class="filters">
            <label>
                Desde
                <input type="date" name="from" [(ngModel)]="filters.from">
            </label>
            <label>
                Hasta
                <input type="date" name="to" [(ngModel)]="filters.to">
            </label>
            <label>
                Orden
                <select name="ordering" [(ngModel)]="filters.ordering">
                    <option value="-fecha">M√°s recientes</option>
                    <option value="fecha">M√°s antiguos</option>
                    <option value="coste">Coste asc</option>
                    <option value="-coste">Coste desc</option>
                </select>
            </label>
            <div class="filterActions">
                <button (click)="applyFilters()">Aplicar</button>
                <button (click)="clearFilters()" class="ghost">
                    Limpiar
                </button>
            </div>
        </section>

        <section class="actions">
            <div class="counter">
                {{ loadingTickets ? 'Cargando...' : filteredTickets.length + ' ticket(s)' }}
            </div>
            <button class="primary" (click)="openModal()">
                ‚ûï Crear ticket
            </button>
        </section>

        <div class="error" *ngIf="error">{{ error }}</div>
        <div class="success" *ngIf="info">{{ info }}</div>

        <section class="list">
            <div class="placeholder" *ngIf="loadingTickets">Cargando tickets...</div>

            <div class="placeholder" *ngIf="!loadingTickets && filteredTickets.length === 0">
                No hay tickets. ¬°Crea el primero!
            </div>

            <article *ngFor="let ticket of filteredTickets" class="card">
                <div>
                    <h3>{{ ticket.titulo }}</h3>
                    <p class="date">{{ formatDate(ticket.fecha) }}</p>
                    <p class="amount">{{ formatCurrency(ticket.coste, ticket.moneda) }}</p>
                </div>
                <div class="cardActions">
                    <button (click)="openModal(ticket)">‚úèÔ∏è Editar</button>
                    <button (click)="handleDelete(ticket.id)" class="danger">
                        üóëÔ∏è Eliminar
                    </button>
                </div>
            </article>
        </section>
    </main>

    <div class="modalBackdrop" *ngIf="modalOpen" (click)="closeModal()">
        <div class="modal" (click)="$event.stopPropagation()">
            <h2>{{ editingTicket ? 'Editar ticket' : 'Crear ticket' }}</h2>
            <form class="modalForm" (submit)="handleSubmit(); $event.preventDefault()">
                <label>
                    Concepto
                    <input name="titulo" [(ngModel)]="form.titulo" required>
                </label>
                <label>
                    Fecha
                    <input type="datetime-local" name="fecha" [(ngModel)]="form.fecha" required>
                </label>
                <label>
                    Coste
                    <input type="number" step="0.01" name="coste" [(ngModel)]="form.coste" required>
                </label>
                <label>
                    Moneda
                    <input name="moneda" maxlength="3" [(ngModel)]="form.moneda">
                </label>

                <div class="modalActions">
                    <button type="submit" class="primary">
                        {{ editingTicket ? 'Guardar cambios' : 'Crear ticket' }}
                    </button>
                    <button type="button" class="ghost" (click)="closeModal()">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modalBackdrop" *ngIf="showEditModal" (click)="closeEditModal()">
        <div class="modal edit-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Editar mis datos</h3>
                <button class="close-btn" (click)="closeEditModal()">√ó</button>
            </div>

            <div class="alert error" *ngIf="editError">{{ editError }}</div>
            <div class="alert success" *ngIf="editSuccess">{{ editSuccess }}</div>

            <div class="form-group">
                <label>Usuario</label>
                <input type="text" [value]="editData.username" (input)="onEditFieldChange('username', $any($event.target).value)" />
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" [value]="editData.email" (input)="onEditFieldChange('email', $any($event.target).value)" />
            </div>

            <div class="form-group">
                <label>Telegram ID</label>
                <input type="number" [value]="editData.telegram_id" (input)="onEditFieldChange('telegram_id', $any($event.target).value)" />
            </div>

            <div class="form-group">
                <label>Contrase√±a actual</label>
                <div class="password-field">
                    <input [type]="showOldPassword ? 'text' : 'password'" placeholder="Obligatoria para cambiar la contrase√±a"
                        [value]="editData.oldPassword" (input)="onEditFieldChange('oldPassword', $any($event.target).value)" />
                    <button type="button" class="toggle-eye" (click)="toggleOldPasswordVisibility()">
                        {{ showOldPassword ? 'Ocultar' : 'Ver' }}
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label>Nueva contrase√±a</label>
                <div class="password-field">
                    <input [type]="showNewPassword1 ? 'text' : 'password'" placeholder="Introduce la nueva contrase√±a"
                        [value]="editData.newPassword1" (input)="onEditFieldChange('newPassword1', $any($event.target).value)" />
                    <button type="button" class="toggle-eye" (click)="toggleNewPassword1Visibility()">
                        {{ showNewPassword1 ? 'Ocultar' : 'Ver' }}
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label>Repite la nueva contrase√±a</label>
                <div class="password-field">
                    <input [type]="showNewPassword2 ? 'text' : 'password'" placeholder="Repite la nueva contrase√±a"
                        [value]="editData.newPassword2" (input)="onEditFieldChange('newPassword2', $any($event.target).value)" />
                    <button type="button" class="toggle-eye" (click)="toggleNewPassword2Visibility()">
                        {{ showNewPassword2 ? 'Ocultar' : 'Ver' }}
                    </button>
                </div>
            </div>

            <div class="modal-actions">
                <button class="secondary" type="button" (click)="closeEditModal()">Cancelar</button>
                <button class="primary" type="button" [disabled]="editLoading" (click)="saveUserEdits()">
                    {{ editLoading ? 'Guardando...' : 'Guardar cambios' }}
                </button>
            </div>
        </div>
    </div>
</div>

<ng-template #loadingOrRedirect>
    <div class="fullscreen" *ngIf="authStatus === 'checking'">
        <p>üîÑ Verificando autenticaci√≥n...</p>
    </div>
</ng-template>