<div class="fixed inset-0 w-full flex flex-col bg-[#102217] font-workout text-white overflow-hidden">
    <!-- TopAppBar -->
    <div class="flex items-center bg-[#102217] p-4 pb-2 sticky top-0 z-10 justify-between shrink-0">
        <button (click)="goBack()"
            class="flex size-12 shrink-0 items-center justify-center rounded-full hover:bg-white/10 transition-colors">
            <span class="material-symbols-outlined text-white" style="font-size: 24px;">arrow_back</span>
        </button>
        <h2 class="text-white text-lg font-bold leading-tight tracking-tight flex-1 text-center truncate px-2">
            {{ exercise()?.custom_name || exercise()?.exercise_detail?.name || 'Cargando...' }}
        </h2>

        <!-- Info and Edit Buttons -->
        @if (!loading() && exercise()) {
        <div class="flex items-center gap-1">
            <button (click)="toggleInfoModal()"
                class="flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined text-slate-300" style="font-size: 20px;">info</span>
            </button>
            <button (click)="toggleEdit()"
                class="flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined text-white" style="font-size: 20px;">edit</span>
            </button>
        </div>
        } @else {
        <div class="size-12 shrink-0"></div>
        }
    </div>

    <!-- Main Scrollable Content -->
    <div class="flex-1 overflow-y-auto no-scrollbar pb-32" (touchstart)="onTouchStart($event)"
        (touchend)="onTouchEnd($event)">
        <!-- Loading State -->
        @if (loading()) {
        <div class="flex justify-center py-12">
            <div class="w-8 h-8 border-2 border-[#13ec6a] border-t-transparent rounded-full animate-spin"></div>
        </div>
        }

        @if (!loading() && exercise()) {
        <!-- Image Carousel -->
        @if (exerciseImages().length > 0) {
        <div class="px-4 py-2">
            <div
                class="relative w-full aspect-video rounded-xl overflow-hidden bg-[#1d3627] shadow-sm border border-white/5">
                <!-- Images Container - Infinite Sliding -->
                <div class="flex h-full ease-out cursor-pointer" [class.transition-transform]="!isImageWrapAround()"
                    [class.duration-300]="!isImageWrapAround()"
                    [style.transform]="'translateX(-' + (virtualImageIndex() * 100) + '%)'"
                    (click)="showFullscreenImage.set(true)">
                    @for (img of infiniteImages(); track $index) {
                    <div class="flex-shrink-0 w-full h-full">
                        <img [src]="img.url" alt="Exercise Image" class="w-full h-full object-cover">
                    </div>
                    }
                </div>

                <!-- Navigation Arrows (only if more than 1 image) -->
                @if (exerciseImages().length > 1) {
                <button (click)="prevImage()"
                    class="absolute left-2 top-1/2 -translate-y-1/2 flex size-8 items-center justify-center rounded-full bg-black/40 text-white backdrop-blur-sm hover:bg-black/60 transition-colors z-10">
                    <span class="material-symbols-outlined" style="font-size: 20px;">chevron_left</span>
                </button>
                <button (click)="nextImage()"
                    class="absolute right-2 top-1/2 -translate-y-1/2 flex size-8 items-center justify-center rounded-full bg-black/40 text-white backdrop-blur-sm hover:bg-black/60 transition-colors z-10">
                    <span class="material-symbols-outlined" style="font-size: 20px;">chevron_right</span>
                </button>

                <!-- Dots Indicator -->
                <div class="absolute bottom-2 left-0 right-0 flex justify-center gap-1.5 z-10">
                    @for (img of exerciseImages(); track img.id) {
                    <button (click)="goToImage($index)" class="h-1.5 rounded-full transition-all duration-300"
                        [class.w-4]="$index === realImageIndex()" [class.bg-[#13ec6a]]="$index === realImageIndex()"
                        [class.w-1.5]="$index !== realImageIndex()" [class.bg-white/40]="$index !== realImageIndex()">
                    </button>
                    }
                </div>
                }
            </div>
        </div>
        }

        <!-- Target Card -->
        <div class="px-4 py-2 overflow-hidden select-none" (touchstart)="onTouchStart($event)"
            (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd($event)">

            <!-- Carousel Track -->
            <div class="flex transition-transform will-change-transform" [style.transform]="getTransform()"
                [class.duration-300]="!isSwiping()" [class.ease-out]="!isSwiping()"
                [class.transition-none]="isSwiping()">

                @for (version of allVersions(); track version.id) {
                <div class="w-full shrink-0">
                    <div class="flex flex-col gap-4 rounded-xl bg-[#1d3627] p-5 shadow-sm border border-white/5 mx-0.5">
                        <div class="flex items-center justify-between">
                            <h3 class="text-slate-400 text-sm font-medium uppercase tracking-wider">
                                {{ version.variant_of ? 'Variante' : 'Objetivo' }}
                            </h3>
                            <button (click)="editTarget()"
                                class="flex items-center gap-1 text-[#13ec6a] text-sm font-medium">
                                <span class="material-symbols-outlined" style="font-size: 16px;">edit</span>
                                Editar
                            </button>
                        </div>
                        <!-- Cardio or Strength Stats -->
                        @if (version.is_cardio) {
                        <!-- Cardio Mode -->
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex flex-col">
                                <span class="text-3xl font-bold text-white">{{ version.target_duration_minutes }}</span>
                                <span class="text-slate-400 text-xs font-medium uppercase">Minutos</span>
                            </div>
                            <div class="h-10 w-px bg-white/10"></div>
                            <div class="flex flex-col">
                                <span class="text-3xl font-bold text-white">{{ version.target_distance_km }}</span>
                                <span class="text-slate-400 text-xs font-medium uppercase">Km</span>
                            </div>
                            <div class="h-10 w-px bg-white/10"></div>
                            <div class="flex flex-col">
                                <span class="text-3xl font-bold text-[#13ec6a]">{{ version.target_resistance }}</span>
                                <span class="text-slate-400 text-xs font-medium uppercase">Resistencia</span>
                            </div>
                        </div>
                        } @else {
                        <!-- Strength Mode -->
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex flex-col">
                                <span class="text-3xl font-bold text-white">{{ version.target_sets }}</span>
                                <span class="text-slate-400 text-xs font-medium uppercase">Series</span>
                            </div>
                            <div class="h-10 w-px bg-white/10"></div>
                            <div class="flex flex-col">
                                <span class="text-3xl font-bold text-white">{{ version.target_reps }}</span>
                                <span class="text-slate-400 text-xs font-medium uppercase">Rango Reps</span>
                            </div>
                            <div class="h-10 w-px bg-white/10"></div>
                            <div class="flex flex-col">
                                <span class="text-3xl font-bold text-[#13ec6a]">{{ version.target_weight }}</span>
                                <span class="text-slate-400 text-xs font-medium uppercase">Kg</span>
                            </div>
                        </div>
                        }
                    </div>
                </div>
                }
            </div>

            <!-- Variant Indicator -->
            @if (allVersions().length > 1) {
            <div class="flex justify-center pt-3 pb-1 gap-2">
                @for (version of allVersions(); track version.id) {
                <button (click)="goToVariant($index)" class="h-1.5 rounded-full transition-all duration-300"
                    [class.w-6]="$index === currentVariantIndex()"
                    [class.bg-[#13ec6a]]="$index === currentVariantIndex()"
                    [class.w-2]="$index !== currentVariantIndex()"
                    [class.bg-white/30]="$index !== currentVariantIndex()">
                </button>
                }
            </div>
            }
        </div>

        <!-- Add Variant Button -->
        <div class="px-4 py-2">
            <div (click)="openVariantModal()"
                class="w-full flex items-center justify-center gap-2 py-3 px-4 rounded-xl border-2 border-dashed border-[#13ec6a]/40 text-[#13ec6a] hover:bg-[#13ec6a]/10 transition-colors group cursor-pointer select-none">
                <span class="material-symbols-outlined" style="font-size: 20px;">add_circle_outline</span>
                <span class="font-medium">Añadir versión</span>
                <!-- Info icon with tooltip -->
                <button (click)="toggleVariantInfo(); $event.stopPropagation()"
                    class="relative ml-2 size-5 rounded-full bg-white/10 text-slate-400 hover:bg-white/20 flex items-center justify-center">
                    <span class="material-symbols-outlined" style="font-size: 14px;">info</span>
                    <!-- Tooltip -->
                    @if (showVariantInfo()) {
                    <div
                        class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-56 p-3 rounded-lg bg-[#0a1910] border border-[#13ec6a]/30 text-xs text-slate-300 shadow-xl z-20">
                        Añade una versión alternativa del ejercicio para cuando no esté disponible el equipo
                        principal (ej: máquina en lugar de barra).
                        <div
                            class="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2 rotate-45 w-2 h-2 bg-[#0a1910] border-r border-b border-[#13ec6a]/30">
                        </div>
                    </div>
                    }
                </button>
            </div>
        </div>
        <!-- Charts Section -->
        <div class="flex flex-wrap gap-4 px-4 py-4">
            <div class="flex min-w-72 flex-1 flex-col gap-2">
                <div class="flex items-end justify-between">
                    <div>
                        @if (exercise()?.is_cardio) {
                        <p class="text-white text-base font-medium leading-normal">Última Distancia</p>
                        <p class="text-white tracking-tight text-[32px] font-bold leading-tight truncate">{{
                            lastCardioDistance() }} km</p>
                        } @else {
                        <p class="text-white text-base font-medium leading-normal">Progreso de Fuerza</p>
                        <p class="text-white tracking-tight text-[32px] font-bold leading-tight truncate">{{
                            currentMaxWeight() }} kg</p>
                        }
                    </div>
                    <div class="flex flex-col items-end pb-1">
                        <div class="flex items-center gap-1 px-2 py-0.5 rounded-full"
                            [class]="progressPercent() >= 0 ? 'text-[#13ec6a] bg-[#13ec6a]/10' : 'text-red-500 bg-red-500/10'">
                            @if (progressPercent() >= 0) {
                            <span class="material-symbols-outlined" style="font-size: 16px;">trending_up</span>
                            <span class="text-sm font-bold">+{{ progressPercent() }}%</span>
                            } @else {
                            <span class="material-symbols-outlined" style="font-size: 16px;">trending_down</span>
                            <span class="text-sm font-bold">{{ progressPercent() }}%</span>
                            }
                        </div>
                        <p class="text-slate-500 text-xs mt-1">Últimas 6 Semanas</p>
                    </div>
                </div>
                <!-- Dynamic Chart -->
                <div class="h-[180px] w-full">
                    @if (weightChartData().datasets.length > 0 && (weightChartData().datasets[0].data.length) > 0 &&
                    !weightChartLoading())
                    {
                    <canvas baseChart [data]="weightChartData()" [type]="chartType" [options]="chartOptions">
                    </canvas>
                    } @else {
                    <div class="flex items-center justify-center h-full text-slate-500 text-sm">
                        <span class="material-symbols-outlined mr-2" style="font-size: 20px;">show_chart</span>
                        Sin datos de progreso aún
                    </div>
                    }
                </div>
            </div>
        </div>

        <!-- Unified Info Modal -->
        @if (showInfoModal()) {
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fadeIn"
            (click)="toggleInfoModal()">
            <div class="w-full max-w-sm rounded-xl bg-[#13ec6a]/10 border border-[#13ec6a]/20 overflow-hidden shadow-2xl animate-slideUp backdrop-blur-md"
                (click)="$event.stopPropagation()">

                <!-- Modal Header -->
                <div class="flex items-center justify-between p-5 pb-0">
                    <div class="flex items-center gap-2">
                        @if (infoTabIndex() === 0) {
                        <span class="material-symbols-outlined text-[#13ec6a]" style="font-size: 20px;">lightbulb</span>
                        <h3 class="text-[#13ec6a] text-sm font-bold uppercase tracking-wider">Consejo</h3>
                        } @else {
                        <span class="material-symbols-outlined text-[#13ec6a]"
                            style="font-size: 20px;">description</span>
                        <h3 class="text-[#13ec6a] text-sm font-bold uppercase tracking-wider">Notas</h3>
                        }
                    </div>
                    <button (click)="toggleInfoModal()"
                        class="size-8 flex items-center justify-center rounded-full bg-white/5 text-slate-400 hover:bg-white/10 transition-colors">
                        <span class="material-symbols-outlined" style="font-size: 18px;">close</span>
                    </button>
                </div>

                <!-- Swipeable Content -->
                <div class="relative overflow-hidden" (touchstart)="onInfoTouchStart($event)"
                    (touchmove)="onInfoTouchMove($event)" (touchend)="onInfoTouchEnd($event)">

                    <div class="flex transition-transform will-change-transform"
                        [style.transform]="'translateX(calc(-' + (infoTabIndex() * 100) + '% + ' + infoSwipeOffset() + 'px))'"
                        [class.duration-300]="!isInfoSwiping()" [class.ease-out]="!isInfoSwiping()">

                        <!-- Slide 1: Tips -->
                        <div class="w-full shrink-0 p-5">
                            @if (exercise()?.is_cardio) {
                            <p class="text-slate-300 text-sm leading-relaxed">
                                ¡Buen ritmo en tu última sesión! Para mejorar tu resistencia, intenta aumentar
                                <span class="text-[#13ec6a] font-bold">5 minutos</span> o
                                <span class="text-[#13ec6a] font-bold">0.5 km</span> en tu próxima carrera.
                            </p>
                            } @else {
                            <p class="text-slate-300 text-sm leading-relaxed">
                                ¡Excelente trabajo en tu última serie! Tu velocidad fue alta en las reps finales.
                                Intenta
                                aumentar el peso en
                                <span class="text-[#13ec6a] font-bold">2.5 kg</span> en la próxima sesión para mantener
                                la
                                sobrecarga progresiva.
                            </p>
                            }
                        </div>

                        <!-- Slide 2: Notes -->
                        <div class="w-full shrink-0 p-5">
                            @if (exercise()?.note) {
                            <p class="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">{{ exercise()?.note }}
                            </p>
                            } @else {
                            <div class="flex flex-col items-center justify-center py-4 text-slate-500 gap-2">
                                <span class="material-symbols-outlined" style="font-size: 32px;">note_stack</span>
                                <p class="text-xs">Sin notas para este ejercicio</p>
                            </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Tab Indicators -->
                <div class="flex justify-center pb-4 gap-2">
                    <button (click)="infoTabIndex.set(0)" class="h-1.5 rounded-full transition-all duration-300"
                        [class.w-4]="infoTabIndex() === 0" [class.bg-[#13ec6a]]="infoTabIndex() === 0"
                        [class.w-1.5]="infoTabIndex() !== 0" [class.bg-white/20]="infoTabIndex() !== 0">
                    </button>
                    <button (click)="infoTabIndex.set(1)" class="h-1.5 rounded-full transition-all duration-300"
                        [class.w-4]="infoTabIndex() === 1" [class.bg-[#13ec6a]]="infoTabIndex() === 1"
                        [class.w-1.5]="infoTabIndex() !== 1" [class.bg-white/20]="infoTabIndex() !== 1">
                    </button>
                </div>
            </div>
        </div>
        }

        <!-- Section Header -->
        <div>
            <h3 class="text-white text-lg font-bold leading-tight tracking-tight px-4 pb-2 pt-2">Historial Reciente
            </h3>
        </div>

        <!-- History List Items -->
        <div class="flex flex-col gap-3 px-4 pb-32">
            @for (item of recentHistory(); track item.id; let i = $index) {
            <div
                class="flex items-center justify-between bg-[#1d3627] p-4 rounded-[20px] shadow-sm border border-white/5 relative overflow-hidden group">
                <!-- Date & Icon -->
                <div class="flex items-center gap-4 z-10">
                    <div class="flex items-center justify-center rounded-xl shrink-0 size-12"
                        [class]="i === 0 ? 'bg-[#13ec6a]/20 text-[#13ec6a]' : 'bg-[#2a4a38] text-slate-400'">
                        @if (item.exerciseIcon && item.exerciseIcon.includes('/')) {
                        <img [src]="item.exerciseIcon" class="w-6 h-6 object-contain" [class.filter-green]="i === 0">
                        } @else {
                        <span class="material-symbols-outlined" style="font-size: 24px;">{{ item.exerciseIcon ||
                            'calendar_today' }}</span>
                        }
                    </div>
                    <div class="flex flex-col gap-0.5">
                        <p class="text-white text-base font-bold leading-tight">{{ formatDate(item.date) }}</p>
                        @if (exercise()?.is_cardio) {
                        <p [class]="i === 0 ? 'text-[#13ec6a]' : 'text-slate-400'" class="text-sm font-medium">{{
                            item.duration_minutes }} min</p>
                        } @else {
                        <p [class]="i === 0 ? 'text-[#13ec6a]' : 'text-slate-400'" class="text-sm font-medium">{{
                            item.weight }} kg</p>
                        }
                    </div>
                </div>

                <!-- Stats & Actions -->
                <div class="flex items-center gap-4 z-10">
                    <div class="flex flex-col items-end gap-0.5">
                        @if (exercise()?.is_cardio) {
                        <p class="text-white text-lg font-bold leading-tight">{{ item.distance_km }} <span
                                class="text-xs font-medium text-slate-400 uppercase ml-0.5">Km</span></p>
                        } @else {
                        <p class="text-white text-lg font-bold leading-tight">{{ item.reps }} <span
                                class="text-xs font-medium text-slate-400 uppercase ml-0.5">Reps</span></p>
                        <p class="text-slate-400 text-xs font-medium">{{ item.setsCount }} Series</p>
                        @if (item.rir !== null && item.rir !== undefined) {
                        <p class="text-slate-400 text-xs font-medium">RIR {{ item.rir }}</p>
                        }
                        }
                    </div>

                    <!-- Delete Button -->
                    <button (click)="deleteSet(item)"
                        class="size-8 flex items-center justify-center rounded-full bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white transition-colors">
                        <span class="material-symbols-outlined" style="font-size: 18px;">delete</span>
                    </button>
                </div>

                <!-- Hover/bg effect -->
                <div class="absolute inset-0 bg-white/0 group-hover:bg-white/5 transition-colors pointer-events-none">
                </div>
            </div>
            }
        </div>
        }
    </div>

    <!-- Edit Name Modal -->
    @if (isEditing()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fadeIn">
        <div
            class="w-full max-w-md bg-[#102217] rounded-3xl border border-white/10 overflow-hidden shadow-2xl flex flex-col max-h-[90vh] animate-slideUp">
            <div class="flex items-center justify-between p-5 border-b border-white/5">
                <h3 class="text-white font-bold text-lg">Editar Ejercicio</h3>
                <button (click)="toggleEdit()"
                    class="size-8 flex items-center justify-center rounded-full bg-white/5 text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-5 overflow-y-auto custom-scrollbar flex flex-col gap-6">
                <!-- Name Input -->
                <div class="flex flex-col gap-2">
                    <label class="text-[#9cacba] text-xs font-bold uppercase tracking-wider pl-1">Nombre</label>
                    <input type="text" [value]="editName()" (input)="updateEditName($event)"
                        class="w-full bg-[#1d3627] border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/30 focus:outline-none focus:border-[#13ec6a] transition-all">
                </div>

                <!-- Images Management -->
                <div class="flex flex-col gap-3">
                    <label class="text-[#9cacba] text-xs font-bold uppercase tracking-wider pl-1">Imágenes</label>

                    <div class="grid grid-cols-3 gap-3">
                        @for (img of exerciseImages(); track img.id) {
                        <div class="relative aspect-square rounded-xl overflow-hidden group bg-[#1d3627] shadow-sm">
                            <img [src]="img.url" class="size-full object-cover">
                            <div
                                class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <button (click)="deleteImageConfirm(img.id)"
                                    class="size-8 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-transform hover:scale-110">
                                    <span class="material-symbols-outlined text-sm">delete</span>
                                </button>
                            </div>
                        </div>
                        }

                        <button (click)="fileInput.click()"
                            class="aspect-square rounded-xl border-2 border-dashed border-[#13ec6a]/30 flex flex-col items-center justify-center gap-1 hover:bg-[#13ec6a]/5 hover:border-[#13ec6a]/50 transition-all group active:scale-95">
                            <span
                                class="material-symbols-outlined text-[#13ec6a] group-hover:scale-110 transition-transform">add_photo_alternate</span>
                            <span class="text-[10px] text-[#13ec6a] font-medium">Añadir</span>
                        </button>
                    </div>
                    <input #fileInput type="file" hidden multiple accept="image/*" (change)="onFileSelected($event)">
                </div>
            </div>

            <div class="p-5 border-t border-white/5 flex gap-3 bg-[#0a160f]/50">
                <button (click)="toggleEdit()"
                    class="flex-1 py-3.5 rounded-xl font-bold bg-[#1d3627] text-slate-300 hover:bg-[#2a4a38] transition-colors">
                    Cancelar
                </button>
                <button (click)="saveChanges()"
                    class="flex-1 py-3.5 rounded-xl font-bold bg-[#13ec6a] text-[#102217] hover:bg-[#0fb650] shadow-lg shadow-[#13ec6a]/20 transition-all flex items-center justify-center gap-2"
                    [disabled]="isSaving()">
                    @if (isSaving()) {
                    <div class="size-4 border-2 border-[#102217] border-t-transparent rounded-full animate-spin">
                    </div>
                    } @else {
                    Guardar
                    }
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Edit Target Modal -->
    @if (showTargetModal()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fadeIn">
        <div
            class="w-full max-w-sm bg-[#102217] rounded-3xl border border-white/10 overflow-hidden shadow-2xl animate-slideUp">
            <div class="flex items-center justify-between p-5 border-b border-white/5">
                <h3 class="text-white font-bold text-lg">Editar Objetivo</h3>
                <button (click)="closeTargetModal()"
                    class="size-8 flex items-center justify-center rounded-full bg-white/5 text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-6 flex flex-col gap-5">
                @if (exercise()?.is_cardio) {
                <!-- Cardio Fields -->
                <div class="flex flex-col gap-2">
                    <label class="text-slate-400 font-medium text-sm uppercase tracking-wider">Duración
                        (Minutos)</label>
                    <input type="number" [value]="newTargetDuration()"
                        (input)="newTargetDuration.set(+$any($event.target).value)"
                        class="w-full bg-[#1d3627] border border-white/10 rounded-xl px-4 py-3 text-white text-center font-bold focus:border-[#13ec6a] outline-none">
                </div>

                <div class="flex flex-col gap-2">
                    <label class="text-slate-400 font-medium text-sm uppercase tracking-wider">Distancia (Km)</label>
                    <input type="number" step="0.1" [value]="newTargetDistance()"
                        (input)="newTargetDistance.set(+$any($event.target).value)"
                        class="w-full bg-[#1d3627] border border-white/10 rounded-xl px-4 py-3 text-white text-center font-bold focus:border-[#13ec6a] outline-none">
                </div>

                <div class="flex flex-col gap-2">
                    <label class="text-slate-400 font-medium text-sm uppercase tracking-wider">Resistencia</label>
                    <input type="number" [value]="newTargetResistance()"
                        (input)="newTargetResistance.set(+$any($event.target).value)"
                        class="w-full bg-[#1d3627] border border-white/10 rounded-xl px-4 py-3 text-white text-center font-bold focus:border-[#13ec6a] outline-none">
                </div>
                } @else {
                <!-- Strength Fields -->
                <div class="flex items-center justify-between">
                    <label class="text-slate-400 font-medium">Sets Objetivo</label>
                    <div class="flex items-center gap-3 bg-[#1d3627] rounded-lg p-1">
                        <button (click)="newTargetSets.set(newTargetSets() - 1)"
                            class="size-8 flex items-center justify-center text-white hover:bg-white/5 rounded-md disabled:opacity-50"
                            [disabled]="newTargetSets() <= 0"><span
                                class="material-symbols-outlined">remove</span></button>
                        <span class="text-white font-bold w-4 text-center">{{ newTargetSets() }}</span>
                        <button (click)="newTargetSets.set(newTargetSets() + 1)"
                            class="size-8 flex items-center justify-center text-white hover:bg-white/5 rounded-md"><span
                                class="material-symbols-outlined">add</span></button>
                    </div>
                </div>

                <div class="flex flex-col gap-2">
                    <label class="text-slate-400 font-medium text-sm uppercase tracking-wider">Rango de Reps</label>
                    <input type="text" [value]="newTargetReps()" (input)="newTargetReps.set($any($event.target).value)"
                        class="w-full bg-[#1d3627] border border-white/10 rounded-xl px-4 py-3 text-white text-center font-bold focus:border-[#13ec6a] outline-none">
                </div>

                <div class="flex flex-col gap-2">
                    <label class="text-slate-400 font-medium text-sm uppercase tracking-wider">Peso Objetivo
                        (Kg)</label>
                    <input type="number" [value]="newTargetWeight()"
                        (input)="newTargetWeight.set(+$any($event.target).value)"
                        class="w-full bg-[#1d3627] border border-white/10 rounded-xl px-4 py-3 text-white text-center font-bold focus:border-[#13ec6a] outline-none">
                </div>
                }
            </div>

            <div class="p-5 border-t border-white/5 bg-[#0a160f]/50">
                <button (click)="saveTarget()"
                    class="w-full py-3.5 rounded-xl font-bold bg-[#13ec6a] text-[#102217] hover:bg-[#0fb650] shadow-lg shadow-[#13ec6a]/20 transition-all flex items-center justify-center gap-2"
                    [disabled]="isSaving()">
                    @if (isSaving()) {
                    <div class="size-5 border-2 border-[#102217] border-t-transparent rounded-full animate-spin">
                    </div>
                    } @else {
                    Guardar Objetivo
                    }
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Log Set Modal -->
    @if (showLogModal()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fadeIn">
        <div
            class="w-full max-w-sm bg-[#102217] rounded-3xl border border-white/10 overflow-hidden shadow-2xl animate-slideUp">
            <div class="flex items-center justify-between p-5 border-b border-white/5">
                <h3 class="text-white font-bold text-lg">
                    @if (exercise()?.is_cardio) { Registrar Sesión } @else { Registrar Serie }
                </h3>
                <button (click)="closeLogModal()"
                    class="size-8 flex items-center justify-center rounded-full bg-white/5 text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-6 flex flex-col gap-6">
                @if (exercise()?.is_cardio) {
                <!-- Cardio Fields -->
                <!-- Duration Input -->
                <div class="flex flex-col gap-2">
                    <label class="text-[#9cacba] text-xs font-bold uppercase tracking-wider text-center">Duración
                        (Minutos)</label>
                    <div class="flex items-center justify-center gap-4">
                        <button (click)="logDuration.set(logDuration() - 1)"
                            class="size-10 rounded-full bg-[#1d3627] text-[#13ec6a] hover:bg-[#2a4a38] flex items-center justify-center transition-colors"
                            [disabled]="logDuration() <= 0"><span
                                class="material-symbols-outlined">remove</span></button>
                        <input type="number" [value]="logDuration()"
                            (input)="logDuration.set(+$any($event.target).value)"
                            class="w-24 bg-transparent text-center text-4xl font-bold text-white outline-none border-b-2 border-[#13ec6a] pb-1">
                        <button (click)="logDuration.set(logDuration() + 1)"
                            class="size-10 rounded-full bg-[#1d3627] text-[#13ec6a] hover:bg-[#2a4a38] flex items-center justify-center transition-colors"><span
                                class="material-symbols-outlined">add</span></button>
                    </div>
                </div>

                <!-- Distance Input -->
                <div class="flex flex-col gap-2">
                    <label class="text-[#9cacba] text-xs font-bold uppercase tracking-wider text-center">Distancia
                        (Km)</label>
                    <div class="flex items-center justify-center gap-4">
                        <button (click)="logDistance.set(+(+logDistance() - 0.5).toFixed(2))"
                            class="size-10 rounded-full bg-[#1d3627] text-white hover:bg-[#2a4a38] flex items-center justify-center transition-colors"
                            [disabled]="logDistance() <= 0"><span
                                class="material-symbols-outlined">remove</span></button>
                        <input type="number" step="0.1" [value]="logDistance()"
                            (input)="logDistance.set(+$any($event.target).value)"
                            class="w-24 bg-transparent text-center text-4xl font-bold text-white outline-none border-b-2 border-white/20 pb-1 focus:border-[#13ec6a]">
                        <button (click)="logDistance.set(+(+logDistance() + 0.5).toFixed(2))"
                            class="size-10 rounded-full bg-[#1d3627] text-white hover:bg-[#2a4a38] flex items-center justify-center transition-colors"><span
                                class="material-symbols-outlined">add</span></button>
                    </div>
                </div>

                <!-- Resistance Input -->
                <div class="flex flex-col gap-2">
                    <label
                        class="text-[#9cacba] text-xs font-bold uppercase tracking-wider text-center">Resistencia</label>
                    <div class="flex items-center justify-center gap-4">
                        <button (click)="logResistance.set(logResistance() - 1)"
                            class="size-10 rounded-full bg-[#1d3627] text-[#f97316] hover:bg-[#2a4a38] flex items-center justify-center transition-colors"
                            [disabled]="logResistance() <= 0"><span
                                class="material-symbols-outlined">remove</span></button>
                        <input type="number" [value]="logResistance()"
                            (input)="logResistance.set(+$any($event.target).value)"
                            class="w-24 bg-transparent text-center text-4xl font-bold text-[#f97316] outline-none border-b-2 border-[#f97316] pb-1">
                        <button (click)="logResistance.set(logResistance() + 1)"
                            class="size-10 rounded-full bg-[#1d3627] text-[#f97316] hover:bg-[#2a4a38] flex items-center justify-center transition-colors"><span
                                class="material-symbols-outlined">add</span></button>
                    </div>
                </div>
                } @else {
                <!-- Strength Fields -->
                <!-- Weight Input -->
                <div class="flex flex-col gap-2">
                    <label class="text-[#9cacba] text-xs font-bold uppercase tracking-wider text-center">Peso
                        Realizada
                        (Kg)</label>
                    <div class="flex items-center justify-center gap-4">
                        <button (click)="decrementWeight()"
                            class="size-10 rounded-full bg-[#1d3627] text-[#13ec6a] hover:bg-[#2a4a38] flex items-center justify-center transition-colors"><span
                                class="material-symbols-outlined">remove</span></button>
                        <input type="number" step="0.5" [value]="logWeight()" (input)="updateWeight($event)"
                            class="w-24 bg-transparent text-center text-4xl font-bold text-white outline-none border-b-2 border-[#13ec6a] pb-1">
                        <button (click)="incrementWeight()"
                            class="size-10 rounded-full bg-[#1d3627] text-[#13ec6a] hover:bg-[#2a4a38] flex items-center justify-center transition-colors"><span
                                class="material-symbols-outlined">add</span></button>
                    </div>
                </div>

                <!-- Reps Input -->
                <div class="flex flex-col gap-2">
                    <label class="text-[#9cacba] text-xs font-bold uppercase tracking-wider text-center">Reps
                        Realizadas</label>
                    <div class="flex items-center justify-center gap-4">
                        <button (click)="logReps.set(logReps() - 1)"
                            class="size-10 rounded-full bg-[#1d3627] text-white hover:bg-[#2a4a38] flex items-center justify-center transition-colors"><span
                                class="material-symbols-outlined">remove</span></button>
                        <input type="number" [value]="logReps()" (input)="logReps.set(+$any($event.target).value)"
                            class="w-20 bg-transparent text-center text-4xl font-bold text-white outline-none border-b-2 border-white/20 pb-1 focus:border-[#13ec6a]">
                        <button (click)="logReps.set(logReps() + 1)"
                            class="size-10 rounded-full bg-[#1d3627] text-white hover:bg-[#2a4a38] flex items-center justify-center transition-colors"><span
                                class="material-symbols-outlined">add</span></button>
                    </div>
                </div>

                <!-- Sets Input (Added) -->
                <div class="flex flex-col gap-2">
                    <label class="text-[#9cacba] text-xs font-bold uppercase tracking-wider text-center">Series
                        Realizadas</label>
                    <div class="flex items-center justify-center gap-4">
                        <button (click)="logSets.set(logSets() - 1)"
                            class="size-10 rounded-full bg-[#1d3627] text-white hover:bg-[#2a4a38] flex items-center justify-center transition-colors"
                            [disabled]="logSets() <= 1"><span class="material-symbols-outlined">remove</span></button>
                        <input type="number" [value]="logSets()" (input)="logSets.set(+$any($event.target).value)"
                            class="w-20 bg-transparent text-center text-4xl font-bold text-white outline-none border-b-2 border-white/20 pb-1 focus:border-[#13ec6a]">
                        <button (click)="logSets.set(logSets() + 1)"
                            class="size-10 rounded-full bg-[#1d3627] text-white hover:bg-[#2a4a38] flex items-center justify-center transition-colors"><span
                                class="material-symbols-outlined">add</span></button>
                    </div>
                </div>
                }
            </div>

            <div class="p-5 border-t border-white/5 bg-[#0a160f]/50">
                <button (click)="saveLog()"
                    class="w-full py-3.5 rounded-xl font-bold bg-[#13ec6a] text-[#102217] hover:bg-[#0fb650] shadow-lg shadow-[#13ec6a]/20 transition-all flex items-center justify-center gap-2"
                    [disabled]="isSaving()">
                    @if (isSaving()) {
                    <div class="size-5 border-2 border-[#102217] border-t-transparent rounded-full animate-spin">
                    </div>
                    } @else {
                    <span class="material-symbols-outlined font-bold">check</span>
                    @if (exercise()?.is_cardio) { Registrar Sesión } @else { Registrar Serie }
                    }
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Floating Action Button Area -->
    <div
        class="fixed bottom-0 left-0 w-full p-4 bg-gradient-to-t from-[#102217] via-[#102217] to-transparent z-20 pt-8">
        <button (click)="logNewSet()"
            class="w-full flex items-center justify-center gap-2 bg-[#13ec6a] hover:bg-[#0fb650] text-[#102217] text-lg font-bold py-4 rounded-full shadow-[0_4px_20px_rgba(19,236,106,0.3)] transition-all active:scale-95">
            <span class="material-symbols-outlined font-bold">add</span>
            @if (exercise()?.is_cardio) {
            Registrar Sesión
            } @else {
            Registrar Nueva Serie
            }
        </button>
    </div>

    <!-- Variant Selection Modal -->
    @if (showVariantModal()) {
    <div class="fixed inset-0 z-50 flex items-end justify-center bg-black/60 backdrop-blur-sm"
        (click)="closeVariantModal()">
        <div class="w-full max-w-lg bg-[#102217] rounded-t-3xl p-6 shadow-2xl border-t border-[#13ec6a]/30"
            (click)="$event.stopPropagation()">

            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">
                    {{ showCreateVariant() ? 'Crear Nuevo Ejercicio' : 'Seleccionar Alternativo' }}
                </h3>
                <button (click)="closeVariantModal()"
                    class="size-8 flex items-center justify-center rounded-full bg-white/10 text-white hover:bg-white/20 transition-colors">
                    <span class="material-symbols-outlined" style="font-size: 20px;">close</span>
                </button>
            </div>

            @if (!showCreateVariant()) {
            <!-- Search Mode -->
            <p class="text-slate-400 text-sm mb-4">
                Selecciona un ejercicio de tu rutina o busca uno nuevo.
            </p>

            <!-- Search Input -->
            <div class="relative mb-4">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"
                    style="font-size: 20px;">search</span>
                <input type="text" placeholder="Filtrar ejercicios..." [value]="variantSearchQuery()"
                    (input)="variantSearchQuery.set($any($event.target).value)"
                    class="w-full py-3 pl-10 pr-4 rounded-xl bg-[#1d3627] border border-white/10 text-white placeholder:text-slate-500 focus:outline-none focus:border-[#13ec6a]/50">
            </div>

            <!-- Routine Exercises as Suggestions -->
            <div class="space-y-2 max-h-48 overflow-y-auto always-scroll custom-scrollbar pr-2">
                <p class="text-slate-500 text-xs font-medium uppercase tracking-wider mb-2">Ejercicios de tu rutina</p>

                @for (ex of filteredRoutineExercises(); track ex.id) {
                <button (click)="addVariant(ex.exercise_detail?.id || ex.exercise)"
                    class="w-full flex items-center gap-3 p-3 rounded-xl bg-[#1d3627] hover:bg-[#2a4a38] border border-white/5 transition-colors text-left">
                    <span class="size-10 rounded-lg bg-[#13ec6a]/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-[#13ec6a]"
                            style="font-size: 20px;">fitness_center</span>
                    </span>
                    <div class="flex-1">
                        <p class="text-white font-medium">{{ ex.custom_name || ex.exercise_detail?.name || 'Ejercicio'
                            }}</p>
                        <p class="text-slate-400 text-xs">{{ ex.dayName }}{{ ex.isVariant ? ' (alternativo)' : '' }}</p>
                    </div>
                </button>
                }

                @if (filteredRoutineExercises().length === 0) {
                <p class="text-center text-slate-500 py-4 text-sm">No hay más ejercicios en tu rutina</p>
                }
            </div>

            <!-- Create New Exercise Button -->
            <button (click)="openAddExerciseForVariant()"
                class="w-full mt-4 py-3 rounded-xl border-2 border-dashed border-[#13ec6a]/40 text-[#13ec6a] hover:bg-[#13ec6a]/10 transition-colors font-medium">
                + Crear nuevo ejercicio
            </button>
            }
        </div>
    </div>
    }
</div>

<!-- Delete Set Modal -->
<app-confirm-modal [isOpen]="showDeleteSetModal()" [title]="'Eliminar serie'" [message]="setToDelete()?.setsCount > 1 
        ? '¿Estás seguro de eliminar este grupo de ' + setToDelete()?.setsCount + ' series?' 
        : '¿Estás seguro de eliminar esta serie?'" [confirmText]="'Eliminar'" [cancelText]="'Cancelar'"
    [variant]="'danger'" [icon]="'delete'" (confirmed)="confirmDeleteSet()" (cancelled)="cancelDeleteSet()">
</app-confirm-modal>

<!-- Delete Image Modal -->
<app-confirm-modal [isOpen]="showDeleteImageModal()" [title]="'Eliminar imagen'"
    [message]="'¿Estás seguro de querer eliminar esta imagen?'" [confirmText]="'Eliminar'" [cancelText]="'Cancelar'"
    [variant]="'danger'" [icon]="'image'" (confirmed)="confirmDeleteImage()" (cancelled)="cancelDeleteImage()">
</app-confirm-modal>

<!-- Fullscreen Image Modal -->
@if (showFullscreenImage()) {
<div @fullscreenModal class="fixed inset-0 z-50 bg-black/95 flex items-center justify-center"
    (click)="showFullscreenImage.set(false)">
    <!-- Close Button -->
    <button (click)="showFullscreenImage.set(false); $event.stopPropagation()"
        class="absolute top-4 right-4 z-20 flex size-10 items-center justify-center rounded-full bg-white/10 text-white hover:bg-white/20 transition-colors">
        <span class="material-symbols-outlined">close</span>
    </button>

    <!-- Image Counter -->
    @if (exerciseImages().length > 1) {
    <div class="absolute top-4 left-4 z-20 px-3 py-1.5 rounded-full bg-black/60 text-white text-sm font-medium">
        {{ realImageIndex() + 1 }} / {{ exerciseImages().length }}
    </div>
    }

    <!-- Images Container with swipe -->
    <div class="w-full h-full flex items-center justify-center overflow-hidden touch-pan-y"
        (click)="$event.stopPropagation()" (touchstart)="onFullscreenTouchStart($event)"
        (touchmove)="onFullscreenTouchMove($event)" (touchend)="onFullscreenTouchEnd($event)">
        <div class="flex h-full w-full will-change-transform"
            [style.transition]="fullscreenDragOffset() === 0 && !isImageWrapAround() ? 'transform 400ms cubic-bezier(0.25, 0.46, 0.45, 0.94)' : 'none'"
            [style.transform]="getFullscreenTransform()">
            @for (img of infiniteImages(); track $index) {
            <div class="flex-shrink-0 w-full h-full flex items-center justify-center p-4">
                <img [src]="img.url" alt="Exercise Image"
                    class="max-w-full max-h-full object-contain rounded-lg select-none pointer-events-none">
            </div>
            }
        </div>
    </div>

    <!-- Navigation Arrows -->
    @if (exerciseImages().length > 1) {
    <button (click)="prevImage(); $event.stopPropagation()"
        class="absolute left-4 top-1/2 -translate-y-1/2 flex size-12 items-center justify-center rounded-full bg-black/60 text-white hover:bg-black/80 transition-colors z-20">
        <span class="material-symbols-outlined" style="font-size: 28px;">chevron_left</span>
    </button>
    <button (click)="nextImage(); $event.stopPropagation()"
        class="absolute right-4 top-1/2 -translate-y-1/2 flex size-12 items-center justify-center rounded-full bg-black/60 text-white hover:bg-black/80 transition-colors z-20">
        <span class="material-symbols-outlined" style="font-size: 28px;">chevron_right</span>
    </button>

    <!-- Dots Indicator -->
    <div class="absolute bottom-6 left-0 right-0 flex justify-center gap-2 z-20">
        @for (img of exerciseImages(); track img.id) {
        <button (click)="goToImage($index); $event.stopPropagation()"
            class="h-2 rounded-full transition-all duration-300" [class.w-6]="$index === realImageIndex()"
            [class.bg-[#13ec6a]]="$index === realImageIndex()" [class.w-2]="$index !== realImageIndex()"
            [class.bg-white/40]="$index !== realImageIndex()">
        </button>
        }
    </div>
    }
</div>
}