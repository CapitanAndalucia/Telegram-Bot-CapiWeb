<div class="shared-viewer-container">
    <!-- Loading -->
    @if (loading()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <p>Cargando contenido compartido...</p>
    </div>
    }

    <!-- Error -->
    @if (error()) {
    <div class="error-state">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h2>No se pudo acceder al contenido</h2>
        <p>{{ error() }}</p>
        <button class="primary-btn" (click)="goToLogin()">Iniciar Sesi√≥n</button>
    </div>
    }

    <!-- Content -->
    @if (!loading() && !error() && sharedData()) {
    <div class="shared-content">
        <header class="shared-header">
            <h1>üìÅ Contenido Compartido</h1>
            @if (!isAuthenticated()) {
            <p class="guest-notice">Est√°s viendo esto como invitado</p>
            }
        </header>

        <div class="shared-item-card">
            @if (sharedData().type === 'file') {
            <!-- File View -->
            <div class="file-preview">
                <div class="file-icon">üìÑ</div>
                <div class="file-details">
                    <h2>{{ sharedData().file.filename }}</h2>
                    <div class="meta-info">
                        <span>Tama√±o: {{ formatFileSize(sharedData().file.size) }}</span>
                        <span>Propietario: {{ sharedData().file.owner_username }}</span>
                        <span>Permisos: {{ sharedData().permission === 'edit' ? 'Edici√≥n' : 'Lectura' }}</span>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button class="download-btn" (click)="downloadFile()">
                    ‚¨áÔ∏è Descargar Archivo
                </button>
                @if (isAuthenticated()) {
                <button class="secondary-btn" routerLink="/fileshare">
                    Ir a Mis Archivos
                </button>
                }
            </div>
            } @else {
            <!-- Folder View -->
            <div class="folder-preview">
                <div class="folder-icon">üìÇ</div>
                <div class="folder-details">
                    <h2>{{ sharedData().folder.name }}</h2>
                    <div class="meta-info">
                        <span>Propietario: {{ sharedData().folder.owner_username }}</span>
                        <span>Permisos: {{ sharedData().permission === 'edit' ? 'Edici√≥n' : 'Lectura' }}</span>
                    </div>
                </div>
                <button class="download-folder-btn" (click)="downloadFolder()">
                    ‚¨áÔ∏è Descargar Carpeta
                </button>
            </div>

            <!-- Subfolders -->
            @if (sharedData().subfolders && sharedData().subfolders.length > 0) {
            <div class="subfolder-list">
                <h3>üìÅ Carpetas</h3>
                @for (subfolder of sharedData().subfolders; track subfolder.id) {
                <div class="subfolder-item">
                    <span class="subfolder-icon">üìÅ</span>
                    <span class="subfolder-name">{{ subfolder.name }}</span>
                </div>
                }
            </div>
            }

            <!-- Files in folder - Grid Layout -->
            @if (sharedData().files && sharedData().files.length > 0) {
            <div class="files-section">
                <h3>üìÑ Archivos</h3>
                <div class="files-grid">
                    @for (file of sharedData().files; track file.id) {
                    <div class="file-card" (click)="openPreview(file)">
                        <div class="file-card-header">
                            <span class="file-icon">üìÑ</span>
                            <span class="file-name-truncated">{{ file.filename.length > 15 ? file.filename.substring(0,
                                15) + '...' : file.filename }}</span>
                        </div>
                        <div class="file-thumbnail">
                            @if (file.is_image) {
                            <div class="image-wrapper">
                                <img [appLazyLoad]="getThumbnailUrl(file.id)" [alt]="file.filename"
                                    (lazyLoading)="onImageLoadingChange(file.id, $event)"
                                    [class.loading]="isImageLoading(file.id)" />
                                @if (isImageLoading(file.id)) {
                                <div class="loading-overlay">
                                    <div class="spinner"></div>
                                    <span>Cargando...</span>
                                </div>
                                }
                            </div>
                            } @else {
                            <div class="file-type-icon">
                                {{ getFileIcon(file.filename) }}
                            </div>
                            }
                        </div>
                        <div class="file-card-footer">
                            <span class="file-size">{{ formatFileSize(file.size) }}</span>
                            <button class="download-icon-btn"
                                (click)="downloadFileById(file.id, file.filename); $event.stopPropagation()">
                                ‚¨áÔ∏è
                            </button>
                        </div>
                    </div>
                    }
                </div>
            </div>
            }

            @if ((!sharedData().files || sharedData().files.length === 0) &&
            (!sharedData().subfolders || sharedData().subfolders.length === 0)) {
            <p class="empty-folder">Esta carpeta est√° vac√≠a</p>
            }
            }
        </div>

        @if (!isAuthenticated()) {
        <div class="login-hint">
            <p>¬øTienes cuenta? <a (click)="goToLogin()">Inicia sesi√≥n</a> para obtener acceso permanente.</p>
        </div>
        }
    </div>
    }

    <!-- File Preview Modal -->
    @if (selectedFile()) {
    <app-file-preview-modal [file]="selectedFile()" [customDownloadUrl]="getPublicDownloadUrl(selectedFile().id)"
        [customStreamUrl]="getPublicDownloadUrl(selectedFile().id)" (close)="closePreview()"
        (download)="downloadFileById(selectedFile().id, selectedFile().filename)">
    </app-file-preview-modal>
    }
</div>

<!-- Downloads Menu -->
<app-downloads-menu></app-downloads-menu>