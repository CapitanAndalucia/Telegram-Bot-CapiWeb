<div class="userIconContainer">
    <button class="userButton" (click)="toggleDropdown()" [disabled]="photoUploading()">
        @if (photoUploading()) {
        <div class="avatarSmall avatarLoading">
            <div class="avatar-spinner"></div>
        </div>
        } @else if (user()) {
        @if (user()!.profile_picture_url) {
        <img class="avatarSmall avatarImage" [src]="user()!.profile_picture_url" alt="Avatar" />
        } @else {
        <div class="avatarSmall">{{ user()!.username[0].toUpperCase() }}</div>
        }
        } @else {
        <div class="avatarPlaceholder">游녻</div>
        }
    </button>

    @if (isOpen()) {
    <div class="dropdown">
        <div class="menu">
            @if (user()) {
            <div class="userInfo">
                <span class="menuTitle">Sesi칩n iniciada como</span>
                <p class="userName">{{ user()!.username }}</p>
            </div>
            <button (click)="openEditModal()" class="menuItem">
                <span class="icon">九勇</span> Editar datos
            </button>
            <button (click)="handleLogoutClick()" class="menuItem">
                <span class="icon">游뛁</span> Cerrar Sesi칩n
            </button>
            } @else {
            <div class="userInfo">
                <p class="userName">Cuenta</p>
            </div>
            <button (click)="navigateToLogin()" class="menuItem">
                <span class="icon">游댐</span> Iniciar Sesi칩n
            </button>
            <button (click)="navigateToRegister()" class="menuItem">
                <span class="icon">游닇</span> Registrarse
            </button>
            }
        </div>
    </div>
    }
</div>

<!-- Hidden file input for photo selection -->
<input type="file" #fileInput accept="image/*" (change)="onPhotoSelected($event)" style="display: none;" />

<!-- Edit Modal -->
@if (showEditModal()) {
<div class="modal-backdrop" (click)="closeEditModal()">
    <div class="edit-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Editar mis datos</h3>
            <button class="close-btn" (click)="closeEditModal()">칑</button>
        </div>

        <div class="modal-body">
            @if (editError()) {
            <div class="alert error">{{ editError() }}</div>
            }
            @if (editSuccess()) {
            <div class="alert success">{{ editSuccess() }}</div>
            }

            <!-- Profile Photo Section -->
            <div class="photo-section">
                <div class="current-photo">
                    @if (stagedPhotoUrl()) {
                    <img [src]="stagedPhotoUrl()" alt="Foto de perfil nueva" class="photo-preview" />
                    } @else if (user()?.profile_picture_url) {
                    <img [src]="user()!.profile_picture_url" alt="Foto de perfil" class="photo-preview" />
                    } @else {
                    <div class="photo-placeholder">
                        {{ user()?.username?.[0]?.toUpperCase() || '?' }}
                    </div>
                    }
                </div>
                <button type="button" class="change-photo-btn" (click)="triggerPhotoSelect()">
                    游닝 Cambiar foto
                </button>
            </div>

            <div class="form-group">
                <label>Usuario</label>
                <input type="text" [value]="editData().username"
                    (input)="onEditFieldChange('username', $any($event.target).value)" />
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" [value]="editData().email"
                    (input)="onEditFieldChange('email', $any($event.target).value)" />
            </div>

            <div class="form-group">
                <label>Telegram ID</label>
                <input type="number" [value]="editData().telegram_id"
                    (input)="onEditFieldChange('telegram_id', $any($event.target).value)" />
            </div>

            <div class="form-group">
                <label>Contrase침a actual</label>
                <div class="password-field">
                    <input [type]="showOldPassword() ? 'text' : 'password'"
                        placeholder="Obligatoria para cambiar la contrase침a" [value]="editData().oldPassword"
                        (input)="onEditFieldChange('oldPassword', $any($event.target).value)" />
                    <button type="button" class="toggle-eye" (click)="toggleOldPasswordVisibility()">
                        @if (showOldPassword()) { Ocultar } @else { Ver }
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label>Nueva contrase침a</label>
                <div class="password-field">
                    <input [type]="showNewPassword1() ? 'text' : 'password'" placeholder="Introduce la nueva contrase침a"
                        [value]="editData().newPassword1"
                        (input)="onEditFieldChange('newPassword1', $any($event.target).value)" />
                    <button type="button" class="toggle-eye" (click)="toggleNewPassword1Visibility()">
                        @if (showNewPassword1()) { Ocultar } @else { Ver }
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label>Repite la nueva contrase침a</label>
                <div class="password-field">
                    <input [type]="showNewPassword2() ? 'text' : 'password'" placeholder="Repite la nueva contrase침a"
                        [value]="editData().newPassword2"
                        (input)="onEditFieldChange('newPassword2', $any($event.target).value)" />
                    <button type="button" class="toggle-eye" (click)="toggleNewPassword2Visibility()">
                        @if (showNewPassword2()) { Ocultar } @else { Ver }
                    </button>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="secondary" (click)="closeEditModal()">Cancelar</button>
            <button class="primary" [disabled]="editLoading()" (click)="saveUserEdits()">
                @if (editLoading()) { Guardando... } @else { Guardar cambios }
            </button>
        </div>
    </div>
</div>
}

<!-- Profile Photo Editor -->
@if (showPhotoEditor() && selectedPhotoFile()) {
<app-profile-photo-editor [imageFile]="selectedPhotoFile()" (apply)="onPhotoApply($event)" (cancel)="onPhotoCanceled()">
</app-profile-photo-editor>
}