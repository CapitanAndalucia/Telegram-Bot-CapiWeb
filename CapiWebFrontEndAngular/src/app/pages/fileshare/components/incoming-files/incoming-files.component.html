<div class="incomingFiles" [class.dragging]="isDragging()" (dragover)="handleDragOver($event)"
    (dragleave)="handleDragLeave($event)" (drop)="handleDrop($event)"
    (contextmenu)="handleContextMenu($event, 'background')">
    <div class="filesHeader">
        <div class="headerControls">
            <div class="sortContainer" (click)="$event.stopPropagation()">
                <button class="sortBtn" (click)="toggleSortMenu()">
                    {{ getSortLabel() }}
                    <span class="sortIcon">{{ sortConfig().order === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                </button>

                <div *ngIf="isSortMenuOpen()" class="sortMenu">
                    <div class="sortGroup">
                        <div class="sortHeader">Ordenar por</div>
                        <div class="sortItem" (click)="setSortConfig({field: 'name'}); toggleSortMenu()"
                            [class.active]="sortConfig().field === 'name'">
                            <span *ngIf="sortConfig().field === 'name'">‚úì</span> Nombre
                        </div>
                        <div class="sortItem" (click)="setSortConfig({field: 'date'}); toggleSortMenu()"
                            [class.active]="sortConfig().field === 'date'">
                            <span *ngIf="sortConfig().field === 'date'">‚úì</span> Fecha de modificaci√≥n
                        </div>
                        <div class="sortItem" (click)="setSortConfig({field: 'size'}); toggleSortMenu()"
                            [class.active]="sortConfig().field === 'size'">
                            <span *ngIf="sortConfig().field === 'size'">‚úì</span> Tama√±o
                        </div>
                    </div>

                    <div class="sortDivider"></div>

                    <div class="sortGroup">
                        <div class="sortHeader">Orden</div>
                        <div class="sortItem" (click)="setSortConfig({order: 'asc'}); toggleSortMenu()"
                            [class.active]="sortConfig().order === 'asc'">
                            <span *ngIf="sortConfig().order === 'asc'">‚úì</span> Ascendente
                        </div>
                        <div class="sortItem" (click)="setSortConfig({order: 'desc'}); toggleSortMenu()"
                            [class.active]="sortConfig().order === 'desc'">
                            <span *ngIf="sortConfig().order === 'desc'">‚úì</span> Descendente
                        </div>
                    </div>
                </div>
            </div>

            <div class="viewToggle">
                <button class="toggleBtn" [class.active]="viewMode() === 'list'" (click)="viewMode.set('list')"
                    title="Lista">‚ò∞</button>
                <button class="toggleBtn" [class.active]="viewMode() === 'grid'" (click)="viewMode.set('grid')"
                    title="Cuadr√≠cula">‚äû</button>
            </div>
        </div>
        <div class="breadcrumbs">
            <span class="breadcrumb-root-icon">üìÅ</span>
            <span class="crumb" (click)="handleBreadcrumbClick(0)" [class.active]="breadcrumbs().length === 1"
                (dragover)="handleBreadcrumbDragOver($event, breadcrumbs()[0])"
                (dragenter)="handleBreadcrumbDragEnter($event, breadcrumbs()[0])"
                (dragleave)="handleBreadcrumbDragLeave($event, breadcrumbs()[0])"
                (drop)="handleBreadcrumbDrop($event, breadcrumbs()[0])"
                [class.dropTarget]="hoveredBreadcrumbKey() === breadcrumbKey(breadcrumbs()[0])">
                {{ breadcrumbs()[0]?.name }}
            </span>
            <span *ngIf="breadcrumbs().length > 1" class="separator">‚Ä∫</span>

            <ng-container *ngFor="let crumb of breadcrumbs().slice(1); let i = index; let last = last">
                <span class="crumb" (click)="handleBreadcrumbClick(i + 1)" [class.active]="last"
                    (dragover)="handleBreadcrumbDragOver($event, crumb)"
                    (dragenter)="handleBreadcrumbDragEnter($event, crumb)"
                    (dragleave)="handleBreadcrumbDragLeave($event, crumb)" (drop)="handleBreadcrumbDrop($event, crumb)"
                    [class.dropTarget]="hoveredBreadcrumbKey() === breadcrumbKey(crumb)">
                    {{ crumb.name }}
                </span>
                <span *ngIf="!last" class="separator">‚Ä∫</span>
            </ng-container>
        </div>

    </div>

    <!-- Loading state - initial load -->
    <div *ngIf="loading() && !isNavigating()" class="navigation-spinner-container" style="flex: 1;">
        <div class="navigation-spinner"></div>
    </div>

    <!-- Navigation spinner - shown when navigating between folders -->
    <div *ngIf="isNavigating()" class="navigation-spinner-container" style="flex: 1;">
        <div class="navigation-spinner"></div>
        <p class="navigation-text">Cargando carpeta...</p>
    </div>

    <div *ngIf="!loading() && !isNavigating() && files().length === 0 && folders().length === 0" class="emptyState"
        style="flex: 1;">
        <p>Carpeta vac√≠a</p>
        <p class="dragHint">Arrastra archivos aqu√≠ o click derecho para crear carpeta</p>
    </div>

    <div *ngIf="!loading() && !isNavigating() && (files().length > 0 || folders().length > 0)"
        style="flex: 1; display: flex; flex-direction: column; width: 100%; overflow-x: hidden;">

        <!-- Men√∫ de selecci√≥n - Sticky en PC, Fixed en m√≥vil -->
        <div *ngIf="bulkSelectionActive()" class="floatingSelectionMenu" [class.showing]="bulkSelectionActive()">
            <div class="selectionInfo">
                <div class="selectionCount">
                    <span class="countNumber">{{ selectedFileIds().size + selectedFolderIds().size }}</span>
                    <span class="countText">seleccionados</span>
                </div>
            </div>

            <div class="selectionActions">
                <button class="actionBtn downloadBtn" (click)="downloadSelected()"
                    [disabled]="selectedFileIds().size === 0">
                    <span class="btnIcon">‚¨á</span>
                    <span class="btnText">Descargar</span>
                </button>

                <button class="actionBtn deleteBtn" (click)="deleteSelected()">
                    <span class="btnIcon">üóë</span>
                    <span class="btnText">Eliminar</span>
                </button>

                <button class="actionBtn cancelBtn" (click)="clearSelection()">
                    <span class="btnIcon">‚úï</span>
                    <span class="btnText">Cancelar</span>
                </button>
            </div>
        </div>

        <div class="incomingContent" [class.listMode]="viewMode() === 'list'" [class.selectionMode]="isSelectionMode()">
            <!-- Folders -->
            <ng-container *ngFor="let folder of sortedFolders(); let i = index">
                <div class="folderCard" [class.listMode]="viewMode() === 'list'" [attr.data-folder-id]="folder.id"
                    [class.selected]="isFolderSelected(folder.id)" [class.dropTarget]="hoveredFolderId() === folder.id"
                    [class.shared]="isShared(folder)" [class.context-menu-open]="isContextMenuOpen()"
                    [style.width]="viewMode() === 'grid' ? '200px' : '100%'"
                    [style.height]="viewMode() === 'grid' ? '200px' : '60px'"
                    [style.min-height]="viewMode() === 'grid' ? '200px' : '60px'"
                    [style.max-height]="viewMode() === 'grid' ? '200px' : '60px'"
                    (touchstart)="!isContextMenuOpen() && handleItemTouchStart($event, 'folder', folder)"
                    (touchmove)="!isContextMenuOpen() && handleTouchMove($event, 'folder', folder)"
                    (touchcancel)="handleTouchCancel($event)"
                    (touchend)="!isContextMenuOpen() && handleItemTouchEnd($event, 'folder', folder)"
                    (click)="!isContextMenuOpen() && handleItemClick($event, 'folder', folder)"
                    (contextmenu)="handleContextMenu($event, 'folder', folder)"
                    (dblclick)="!isContextMenuOpen() && navigateToFolder(folder)"
                    (dragover)="handleFolderDragOver($event, folder)"
                    (dragenter)="handleFolderDragEnter($event, folder)"
                    (dragleave)="handleFolderDragLeave($event, folder)" (drop)="handleFileDrop($event, folder)"
                    [draggable]="true" (dragstart)="handleFolderDragStart($event, folder)" (dragend)="handleDragEnd()"
                    [@itemAnimation]="{value: '', params: {delay: i * 30}}">

                    <!-- Visual feedback for long press selection -->
                    <div class="selection-progress-overlay"
                        *ngIf="pressingItemId() === folder.id && !isSelectionMode()">
                        <div class="selection-progress-circle"></div>
                    </div>

                    <div class="new-indicator" *ngIf="folder.has_new_content"></div>


                    <div class="selectionCheckbox" [class.checked]="isFolderSelected(folder.id)"
                        (click)="toggleItemSelection('folder', folder, true); $event.stopPropagation()">
                        <span *ngIf="isFolderSelected(folder.id)">‚úì</span>
                    </div>

                    <ng-container *ngIf="viewMode() === 'grid'">
                        <div class="cardHeader">
                            <div class="cardIconSmall">üìÅ</div>
                            <div class="cardName">{{ folder.name }}</div>
                            <!-- <span (click)="handleContextMenu($event, 'folder', folder); $event.stopPropagation()"
                                class="optionsBtn" [class.active]="isOptionsActive('folder', folder)" title="Opciones">
                                ‚ãÆ
                            </span> -->
                            <img src="assets/icons/menu.png" alt="Opciones"
                                (click)="handleContextMenu($event, 'folder', folder); $event.stopPropagation()"
                                class="optionsBtn" [class.active]="isOptionsActive('folder', folder)"
                                title="Opciones" />
                        </div>
                    </ng-container>

                    <div class="previewContainer">
                        <div class="folderIcon" style="font-size: 3rem; margin: 0;">üìÅ</div>
                    </div>

                    <ng-container *ngIf="viewMode() === 'list'">
                        <div class="fileInfoList">
                            <span class="cardName">{{ folder.name }}</span>
                        </div>
                        <!-- <span (click)="handleContextMenu($event, 'folder', folder); $event.stopPropagation()"
                            class="optionsBtn listModeBtn" [class.active]="isOptionsActive('folder', folder)" title="Opciones">
                            ‚ãÆ
                        </span> -->
                        <img src="assets/icons/menu.png" alt="Opciones"
                            (click)="handleContextMenu($event, 'folder', folder); $event.stopPropagation()"
                            class="optionsBtn" [class.active]="isOptionsActive('folder', folder)" title="Opciones" />
                    </ng-container>
                </div>
            </ng-container>

            <!-- Files -->
            <ng-container *ngFor="let file of sortedFiles(); let i = index">
                <div class="fileCard" [class.listMode]="viewMode() === 'list'" [attr.data-file-id]="file.id"
                    [class.selected]="isFileSelected(file.id)" [class.shared]="isShared(file)" [draggable]="true"
                    [class.context-menu-open]="isContextMenuOpen()" (dragstart)="handleDragStart($event, file)"
                    [style.width]="viewMode() === 'grid' ? '200px' : '100%'"
                    [style.height]="viewMode() === 'grid' ? '200px' : '60px'"
                    [style.min-height]="viewMode() === 'grid' ? '200px' : '60px'"
                    [style.max-height]="viewMode() === 'grid' ? '200px' : '60px'" (dragend)="handleDragEnd()"
                    (touchstart)="!isContextMenuOpen() && handleItemTouchStart($event, 'file', file)"
                    (touchmove)="!isContextMenuOpen() && handleTouchMove($event, 'file', file)"
                    (touchcancel)="handleTouchCancel($event)"
                    (touchend)="!isContextMenuOpen() && handleItemTouchEnd($event, 'file', file)"
                    (click)="!isContextMenuOpen() && handleItemClick($event, 'file', file)"
                    (dblclick)="!isContextMenuOpen() && handleFileClick(file)"
                    (contextmenu)="handleContextMenu($event, 'file', file)" style="cursor: pointer"
                    [@itemAnimation]="{value: '', params: {delay: (sortedFolders().length + i) * 30}}">

                    <!-- Visual feedback for long press selection -->
                    <div class="selection-progress-overlay" *ngIf="pressingItemId() === file.id && !isSelectionMode()">
                        <div class="selection-progress-circle"></div>
                    </div>

                    <div class="new-indicator" *ngIf="!file.is_viewed"></div>

                    <div class="selectionCheckbox" [class.checked]="isFileSelected(file.id)"
                        (click)="toggleItemSelection('file', file, true); $event.stopPropagation()">
                        <span *ngIf="isFileSelected(file.id)">‚úì</span>
                    </div>

                    <ng-container *ngIf="viewMode() === 'grid'">
                        <div class="cardHeader">
                            <div class="cardIconSmall">
                                <img *ngIf="isImage(file.filename)" src="assets/icons/image-file-icon.png" alt="Image"
                                    class="fileTypeIcon" />
                                <span *ngIf="isVideo(file.filename)" style="font-size: 1.2rem;">üé¨</span>
                                <span *ngIf="!isImage(file.filename) && !isVideo(file.filename)">üìÑ</span>
                            </div>
                            <div class="cardName">{{ file.filename }}</div>
                            <!-- <span (click)="handleContextMenu($event, 'file', file); $event.stopPropagation()"
                                class="optionsBtn" [class.active]="isOptionsActive('file', file)" title="Opciones">
                                ‚ãÆ
                            </span> -->
                            <img src="assets/icons/menu.png" alt="Opciones"
                                (click)="handleContextMenu($event, 'file', file); $event.stopPropagation()"
                                class="optionsBtn" [class.active]="isOptionsActive('file', file)" title="Opciones" />

                        </div>
                    </ng-container>

                    <!-- New Phase: Preview Body -->
                    <div class="previewContainer">
                        @if (hasThumbnail(file.filename)) {
                        <div class="imageWrapper">
                            <img [src]="getThumbnailUrl(file.id, file.filename)" [alt]="file.filename" class="fileImage"
                                (load)="onImageLoad(file.id)" (error)="onImageError(file.id)"
                                [style.display]="isImageLoading(file.id) ? 'none' : 'block'" />
                            @if (isImageLoading(file.id)) {
                            <div class="imageLoadingSpinner">
                                <div class="spinner"></div>
                                <span class="loadingText">Cargando...</span>
                            </div>
                            }
                        </div>
                        } @else {
                        <div class="fileIconPlaceholder">{{ isVideo(file.filename) ? 'üé¨' : 'üìÑ' }}</div>
                        }
                    </div>

                    <!-- List View Fallback (keep existing logic for list mode) -->
                    <ng-container *ngIf="viewMode() === 'list'">
                        <div class="fileInfoList">
                            <span class="fileNameList">{{ file.filename }}</span>
                            <span class="fileSizeList">{{ (file.size / 1024).toFixed(1) }} KB</span>
                        </div>
                        <!-- <span (click)="handleContextMenu($event, 'file', file); $event.stopPropagation()"
                            class="optionsBtn listModeBtn" [class.active]="isOptionsActive('file', file)" title="Opciones">
                            ‚ãÆ
                        </span> -->
                        <img src="assets/icons/menu.png" alt="Opciones"
                            (click)="handleContextMenu($event, 'file', file); $event.stopPropagation()"
                            class="optionsBtn listModeBtn" [class.active]="isOptionsActive('file', file)"
                            title="Opciones" />
                    </ng-container>
                </div>
            </ng-container>
        </div>
        <!-- Filler area to capture clicks/drags in empty space below the grid -->
        <div class="content-filler" (contextmenu)="handleContextMenu($event, 'background')"
            (dragover)="handleDragOver($event)" (dragleave)="handleDragLeave($event)" (drop)="handleDrop($event)">
        </div>
    </div>

    <!-- Context Menu: floating on desktop, bottom-sheet modal on mobile -->
    <ng-container *ngIf="contextMenu() as menu">
        <div class="context-menu" [style.top.px]="menu.y" [style.left.px]="menu.x" (click)="$event.stopPropagation()"
            [@menuAnimation]>
            <ng-container *ngIf="menu.type === 'file' || menu.type === 'folder'">
                <button
                    (click)="openShareModal(menu.item!, menu.type === 'file' ? 'file' : 'folder'); closeContextMenu()">
                    <span class="icon">üîó</span> Compartir
                </button>
                <button
                    (click)="menu.type === 'file' ? handleDownload(menu.item!.id, $any(menu.item!).filename) : handleFolderDownload($any(menu.item!)); closeContextMenu()">
                    <span class="icon">‚¨á</span> Descargar
                </button>
                <ng-container *ngIf="menu.type === 'file'">
                    <button (click)="openPreview(menu.item!); closeContextMenu()">
                        <span class="icon">üëÅ</span> Previsualizar
                    </button>
                </ng-container>
                <button (click)="openMoveDialog(menu.item!); closeContextMenu()">
                    <span class="icon">‚û°Ô∏è</span> Mover a...
                </button>
                <button (click)="renameItem(); closeContextMenu()">
                    <span class="icon">‚úè</span> Renombrar
                </button>
                <div class="divider"></div>
                <button class="delete" (click)="deleteItem(); closeContextMenu()">
                    <span class="icon">üóë</span> Eliminar
                </button>
            </ng-container>
            <ng-container *ngIf="menu.type !== 'file' && menu.type !== 'folder'">
                <button (click)="triggerFileUpload(); closeContextMenu()">
                    <span class="icon">üìÑ</span> Subir archivo
                </button>
                <button (click)="createFolder(); closeContextMenu()">
                    <span class="icon">üìÅ</span> Nueva carpeta
                </button>
            </ng-container>
        </div>
    </ng-container>

    <app-share-modal *ngIf="shareModalItem()" [item]="shareModalItem()!" [type]="shareModalType()"
        (close)="closeShareModal()" (shared)="refreshContent()">
    </app-share-modal>

    <!-- Mobile floating action button -->
    <div *ngIf="isMobile()" class="mobile-fab-container" [class.context-menu-open]="mobileFabOpen()">
        <button class="mobile-fab" (click)="mobileFabOpen.set(!mobileFabOpen()); $event.stopPropagation()"
            title="Acciones">
            <img src="assets/icons/agregar-icono.png" alt="Cerrar" class="icon-close" />
        </button>

        <div *ngIf="mobileFabOpen()" class="mobile-fab-menu" (click)="$event.stopPropagation()" [@menuAnimation]>
            <label for="file-upload" class="mobile-fab-item" (click)="mobileFabOpen.set(false)"
                style="cursor: pointer; margin: 0;">Subir
                archivo</label>
            <button class="mobile-fab-item" (click)="openUpload.emit(); mobileFabOpen.set(false)">Enviar
                archivo</button>
            <button class="mobile-fab-item" (click)="createFolder(); mobileFabOpen.set(false)">Crear
                carpeta</button>
        </div>
    </div>
</div>

<!-- Input de archivo oculto para la carga de archivos -->
<input type="file" #fileInput id="file-upload" style="display: none" (change)="onFileSelected($event)" multiple>

<app-file-preview-modal *ngIf="selectedFile()" [file]="selectedFile()!" (close)="closeModal()"
    (download)="handleDownload($event.id, $event.filename)" (delete)="handleDelete($event)"></app-file-preview-modal>

<ng-container *ngIf="moveDialogOpen()">
    <div class="moveDialogOverlay" (click)="closeMoveDialog()">
        <div class="moveDialog" (click)="$event.stopPropagation()">
            <header class="moveDialogHeader">
                <h3>Mover "{{ moveTargetDisplayName() }}"</h3>
                <button class="moveDialogClose icon-only" (click)="closeMoveDialog()" [disabled]="moveDialogBusy()">
                    <img src="assets/icons/boton-x.png" alt="Cerrar" class="icon-close" />
                    <span class="visually-hidden">Cerrar</span>
                </button>
            </header>
            <div class="moveDialogBody">
                <div *ngIf="moveDialogLoading()" class="moveDialogLoading">Cargando carpetas...</div>
                <div *ngIf="!moveDialogLoading()" class="moveDialogList">
                    <ng-container *ngFor="let option of moveOptions()">
                        <button class="moveOptionButton" [disabled]="moveDialogBusy()"
                            [class.active]="isMoveOptionActive(option.id)" (click)="confirmMove(option.id)">
                            <span class="moveOptionIndent" [style.width.rem]="option.depth * 0.8"></span>
                            <span>{{ option.name }}</span>
                        </button>
                    </ng-container>
                </div>
            </div>
            <footer class="moveDialogFooter">
                <button class="secondaryBtn" (click)="closeMoveDialog()" [disabled]="moveDialogBusy()">Cancelar</button>
            </footer>
        </div>
    </div>
</ng-container>