<div class="incomingFiles" [class.dragging]="isDragging()" (dragover)="handleDragOver($event)"
    (dragleave)="handleDragLeave($event)" (drop)="handleDrop($event)"
    (contextmenu)="handleContextMenu($event, 'background')">
    <div class="filesHeader">
        <div class="headerControls">
            <div class="sortContainer" (click)="$event.stopPropagation()">
                <button class="sortBtn" (click)="toggleSortMenu()">
                    {{ getSortLabel() }}
                    <span class="sortIcon">{{ sortConfig().order === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                </button>

                <div *ngIf="isSortMenuOpen()" class="sortMenu">
                    <div class="sortGroup">
                        <div class="sortHeader">Ordenar por</div>
                        <div class="sortItem" (click)="setSortConfig({field: 'name'}); toggleSortMenu()"
                            [class.active]="sortConfig().field === 'name'">
                            <span *ngIf="sortConfig().field === 'name'">‚úì</span> Nombre
                        </div>
                        <div class="sortItem" (click)="setSortConfig({field: 'date'}); toggleSortMenu()"
                            [class.active]="sortConfig().field === 'date'">
                            <span *ngIf="sortConfig().field === 'date'">‚úì</span> Fecha de modificaci√≥n
                        </div>
                        <div class="sortItem" (click)="setSortConfig({field: 'size'}); toggleSortMenu()"
                            [class.active]="sortConfig().field === 'size'">
                            <span *ngIf="sortConfig().field === 'size'">‚úì</span> Tama√±o
                        </div>
                    </div>

                    <div class="sortDivider"></div>

                    <div class="sortGroup">
                        <div class="sortHeader">Orden</div>
                        <div class="sortItem" (click)="setSortConfig({order: 'asc'}); toggleSortMenu()"
                            [class.active]="sortConfig().order === 'asc'">
                            <span *ngIf="sortConfig().order === 'asc'">‚úì</span> Ascendente
                        </div>
                        <div class="sortItem" (click)="setSortConfig({order: 'desc'}); toggleSortMenu()"
                            [class.active]="sortConfig().order === 'desc'">
                            <span *ngIf="sortConfig().order === 'desc'">‚úì</span> Descendente
                        </div>
                    </div>
                </div>
            </div>

            <div class="viewToggle">
                <button class="toggleBtn" [class.active]="viewMode() === 'list'" (click)="viewMode.set('list')"
                    title="Lista">‚ò∞</button>
                <button class="toggleBtn" [class.active]="viewMode() === 'grid'" (click)="viewMode.set('grid')"
                    title="Cuadr√≠cula">‚äû</button>
            </div>
        </div>
        <div class="breadcrumbs">
            <span class="breadcrumb-root-icon">üìÅ</span>
            <span class="crumb" (click)="handleBreadcrumbClick(0)" [class.active]="breadcrumbs().length === 1"
                (dragover)="handleBreadcrumbDragOver($event, breadcrumbs()[0])"
                (dragenter)="handleBreadcrumbDragEnter($event, breadcrumbs()[0])"
                (dragleave)="handleBreadcrumbDragLeave($event, breadcrumbs()[0])"
                (drop)="handleBreadcrumbDrop($event, breadcrumbs()[0])"
                [class.dropTarget]="hoveredBreadcrumbKey() === breadcrumbKey(breadcrumbs()[0])">
                {{ breadcrumbs()[0]?.name }}
            </span>
            <span *ngIf="breadcrumbs().length > 1" class="separator">‚Ä∫</span>

            <ng-container *ngFor="let crumb of breadcrumbs().slice(1); let i = index; let last = last">
                <span class="crumb" (click)="handleBreadcrumbClick(i + 1)" [class.active]="last"
                    (dragover)="handleBreadcrumbDragOver($event, crumb)"
                    (dragenter)="handleBreadcrumbDragEnter($event, crumb)"
                    (dragleave)="handleBreadcrumbDragLeave($event, crumb)" (drop)="handleBreadcrumbDrop($event, crumb)"
                    [class.dropTarget]="hoveredBreadcrumbKey() === breadcrumbKey(crumb)">
                    {{ crumb.name }}
                </span>
                <span *ngIf="!last" class="separator">‚Ä∫</span>
            </ng-container>
        </div>

    </div>

    <p *ngIf="loading()">Cargando...</p>

    <div *ngIf="!loading() && files().length === 0 && folders().length === 0" class="emptyState">
        <p>Carpeta vac√≠a</p>
        <p class="dragHint">Arrastra archivos aqu√≠ o click derecho para crear carpeta</p>
    </div>

    <div *ngIf="!loading() && (files().length > 0 || folders().length > 0)">
        <div *ngIf="bulkSelectionActive()" class="selectionBar">
            <span>{{ selectedFileIds().size + selectedFolderIds().size }} seleccionados</span>
            <button class="clearSelectionBtn" (click)="clearSelection()">‚úï Cancelar</button>
        </div>

        <div class="incomingContent" [class.listMode]="viewMode() === 'list'" [class.selectionMode]="isSelectionMode()"
            [class.animate]="animateList()">
            <!-- Folders -->
            <ng-container *ngFor="let folder of sortedFolders()">
                <div class="folderCard" [class.listMode]="viewMode() === 'list'" [attr.data-folder-id]="folder.id"
                    [class.selected]="isFolderSelected(folder.id)" [class.dropTarget]="hoveredFolderId() === folder.id"
                    (touchstart)="handleItemTouchStart($event, 'folder', folder)"
                    (touchmove)="handleTouchMove($event, 'folder', folder)"
                    (touchcancel)="handleTouchCancel($event)"
                    (touchend)="handleItemTouchEnd($event, 'folder', folder)"
                    (click)="handleItemClick($event, 'folder', folder)"
                    (contextmenu)="handleContextMenu($event, 'folder', folder)" (dblclick)="navigateToFolder(folder)"
                    (dragover)="handleFolderDragOver($event, folder)"
                    (dragenter)="handleFolderDragEnter($event, folder)"
                    (dragleave)="handleFolderDragLeave($event, folder)" (drop)="handleFileDrop($event, folder)"
                    [draggable]="true" (dragstart)="handleFolderDragStart($event, folder)" (dragend)="handleDragEnd()">


                    <div class="selectionCheckbox" [class.checked]="isFolderSelected(folder.id)"
                        (click)="toggleItemSelection('folder', folder, true); $event.stopPropagation()">
                        <span *ngIf="isFolderSelected(folder.id)">‚úì</span>
                    </div>

                    <ng-container *ngIf="viewMode() === 'grid'">
                        <div class="cardHeader">
                            <div class="cardIconSmall">üìÅ</div>
                            <div class="cardName">{{ folder.name }}</div>
                            <span (click)="handleContextMenu($event, 'folder', folder); $event.stopPropagation()"
                                class="optionsBtn" [class.active]="isOptionsActive('folder', folder)" title="Opciones">
                                ‚ãÆ
                            </span>
                        </div>
                    </ng-container>

                    <div class="previewContainer">
                        <div class="folderIcon" style="font-size: 3rem; margin: 0;">üìÅ</div>
                    </div>

                    <ng-container *ngIf="viewMode() === 'list'">
                        <div class="fileInfoList">
                            <span class="cardName">{{ folder.name }}</span>
                        </div>
                        <span (click)="handleContextMenu($event, 'folder', folder); $event.stopPropagation()"
                            class="optionsBtn listModeBtn" [class.active]="isOptionsActive('folder', folder)" title="Opciones">
                            ‚ãÆ
                        </span>
                    </ng-container>
                </div>
            </ng-container>

            <!-- Files -->
            <ng-container *ngFor="let file of sortedFiles()">
                <div class="fileCard" [class.listMode]="viewMode() === 'list'" [attr.data-file-id]="file.id"
                    [class.selected]="isFileSelected(file.id)" [draggable]="true"
                    (dragstart)="handleDragStart($event, file)" (dragend)="handleDragEnd()"
                    (touchstart)="handleItemTouchStart($event, 'file', file)" (touchmove)="handleTouchMove($event, 'file', file)" (touchcancel)="handleTouchCancel($event)" (touchend)="handleItemTouchEnd($event, 'file', file)"
                    (click)="handleItemClick($event, 'file', file)" (dblclick)="handleFileClick(file)"
                    (contextmenu)="handleContextMenu($event, 'file', file)" style="cursor: pointer">

                    <div class="selectionCheckbox" [class.checked]="isFileSelected(file.id)"
                        (click)="toggleItemSelection('file', file, true); $event.stopPropagation()">
                        <span *ngIf="isFileSelected(file.id)">‚úì</span>
                    </div>

                    <ng-container *ngIf="viewMode() === 'grid'">
                        <div class="cardHeader">
                            <div class="cardIconSmall">
                                <img *ngIf="isImage(file.filename)" src="assets/icons/image-file-icon.png" alt="Image"
                                    class="fileTypeIcon" />
                                <span *ngIf="!isImage(file.filename)">üìÑ</span>
                            </div>
                            <div class="cardName">{{ file.filename }}</div>
                            <span (click)="handleContextMenu($event, 'file', file); $event.stopPropagation()"
                                class="optionsBtn" [class.active]="isOptionsActive('file', file)" title="Opciones">
                                ‚ãÆ
                            </span>
                        </div>
                    </ng-container>

                    <!-- New Phase: Preview Body -->
                    <div class="previewContainer">
                        <img *ngIf="isImage(file.filename)" [src]="getFileUrl(file.id)" [alt]="file.filename"
                            class="fileImage" />
                        <div *ngIf="!isImage(file.filename)" class="fileIconPlaceholder">üìÑ</div>
                    </div>

                    <!-- List View Fallback (keep existing logic for list mode) -->
                    <ng-container *ngIf="viewMode() === 'list'">
                        <div class="fileInfoList">
                            <span class="fileNameList">{{ file.filename }}</span>
                            <span class="fileSizeList">{{ (file.size / 1024).toFixed(1) }} KB</span>
                        </div>
                        <span (click)="handleContextMenu($event, 'file', file); $event.stopPropagation()"
                            class="optionsBtn listModeBtn" [class.active]="isOptionsActive('file', file)" title="Opciones">
                            ‚ãÆ
                        </span>
                    </ng-container>
                </div>
            </ng-container>
        </div>
    </div>

    <!-- Context Menu: floating on desktop, bottom-sheet modal on mobile -->
    <ng-container *ngIf="contextMenu() as menu">
        <div *ngIf="!isMobile()" class="context-menu" [style.top.px]="menu.y" [style.left.px]="menu.x"
            (click)="$event.stopPropagation()">
            <ng-container *ngIf="menu.type === 'file' || menu.type === 'folder'">
                <button
                    (click)="openShareModal(menu.item!, menu.type === 'file' ? 'file' : 'folder'); closeContextMenu()">
                    <span class="icon">üîó</span> Compartir
                </button>
                <button
                    (click)="menu.type === 'file' ? handleDownload(menu.item!.id, $any(menu.item!).filename) : handleFolderDownload($any(menu.item!)); closeContextMenu()">
                    <span class="icon">‚¨á</span> Descargar
                </button>
                <ng-container *ngIf="menu.type === 'file'">
                    <button (click)="openPreview(menu.item!); closeContextMenu()">
                        <span class="icon">üëÅ</span> Previsualizar
                    </button>
                </ng-container>
                <button (click)="openMoveDialog(menu.item!); closeContextMenu()">
                    <span class="icon">‚û°Ô∏è</span> Mover a...
                </button>
                <button (click)="renameItem(); closeContextMenu()">
                    <span class="icon">‚úè</span> Renombrar
                </button>
                <div class="divider"></div>
                <button class="delete" (click)="deleteItem(); closeContextMenu()">
                    <span class="icon">üóë</span> Eliminar
                </button>
            </ng-container>
            <ng-container *ngIf="menu.type !== 'file' && menu.type !== 'folder'">
                <button (click)="triggerFileUpload(); closeContextMenu()">
                    <span class="icon">üìÑ</span> Subir archivo
                </button>
                <button (click)="createFolder(); closeContextMenu()">
                    <span class="icon">üìÅ</span> Nueva carpeta
                </button>
            </ng-container>
        </div>

        <!-- Mobile bottom sheet modal -->
        <div *ngIf="isMobile()" class="mobile-context-modal" (click)="$event.stopPropagation()">
            <div class="mobile-context-sheet">
                <header class="mobile-context-header">
                    <div class="mobile-context-title">Opciones</div>
                    <button class="mobile-context-close" (click)="closeContextMenu()">‚úï</button>
                </header>
                <div class="mobile-context-body">
                    <ng-container *ngIf="menu.type === 'file' || menu.type === 'folder'">
                        <button (click)="openShareModal(menu.item!, menu.type === 'file' ? 'file' : 'folder'); closeContextMenu()">Compartir</button>
                        <button (click)="menu.type === 'file' ? handleDownload(menu.item!.id, $any(menu.item!).filename) : handleFolderDownload($any(menu.item!)); closeContextMenu()">Descargar</button>
                        <ng-container *ngIf="menu.type === 'file'">
                            <button (click)="openPreview(menu.item!); closeContextMenu()">Previsualizar</button>
                        </ng-container>
                        <button (click)="openMoveDialog(menu.item!); closeContextMenu()">Mover a...</button>
                        <button (click)="renameItem(); closeContextMenu()">Renombrar</button>
                        <button class="delete" (click)="deleteItem(); closeContextMenu()">Eliminar</button>
                    </ng-container>
                    <ng-container *ngIf="menu.type !== 'file' && menu.type !== 'folder'">
                        <button (click)="triggerFileUpload(); closeContextMenu()">Subir archivo</button>
                        <button (click)="createFolder(); closeContextMenu()">Nueva carpeta</button>
                    </ng-container>
                </div>
            </div>
        </div>
    </ng-container>

    <app-share-modal *ngIf="shareModalItem()" [item]="shareModalItem()!" [type]="shareModalType()"
        (close)="closeShareModal()" (shared)="refreshContent()">
    </app-share-modal>
</div>

<!-- Input de archivo oculto para la carga de archivos -->
<input type="file" id="file-upload" style="display: none" (change)="onFileSelected($event)" multiple>

<app-file-preview-modal *ngIf="selectedFile()" [file]="selectedFile()!" (close)="closeModal()"
    (download)="handleDownload($event.id, $event.filename)" (delete)="handleDelete($event)"></app-file-preview-modal>

<ng-container *ngIf="moveDialogOpen()">
    <div class="moveDialogOverlay" (click)="closeMoveDialog()">
        <div class="moveDialog" (click)="$event.stopPropagation()">
            <header class="moveDialogHeader">
                <h3>Mover "{{ moveTargetDisplayName() }}"</h3>
                <button class="moveDialogClose" (click)="closeMoveDialog()" [disabled]="moveDialogBusy()">‚úï</button>
            </header>
            <div class="moveDialogBody">
                <div *ngIf="moveDialogLoading()" class="moveDialogLoading">Cargando carpetas...</div>
                <div *ngIf="!moveDialogLoading()" class="moveDialogList">
                    <ng-container *ngFor="let option of moveOptions()">
                        <button class="moveOptionButton" [disabled]="moveDialogBusy()"
                            [class.active]="isMoveOptionActive(option.id)" (click)="confirmMove(option.id)">
                            <span class="moveOptionIndent" [style.width.rem]="option.depth * 0.8"></span>
                            <span>{{ option.name }}</span>
                        </button>
                    </ng-container>
                </div>
            </div>
            <footer class="moveDialogFooter">
                <button class="secondaryBtn" (click)="closeMoveDialog()" [disabled]="moveDialogBusy()">Cancelar</button>
            </footer>
        </div>
    </div>
</ng-container>
