<div class="comp-overlay" (click)="onBackdropClick($event); closeDropdown()">
    <div class="comp-modal">
        <div class="modal-header">
            <h3>Compartir {{ type === 'file' ? 'Archivo' : 'Carpeta' }}</h3>
            <button class="close-btn icon-only" (click)="close.emit()">
                <img src="assets/icons/boton-x.png" alt="Cerrar" class="icon-close" />
            </button>
        </div>

        <div class="modal-body">
            <p class="item-name">
                <span class="icon">{{ type === 'file' ? 'üìÑ' : 'üìÅ' }}</span>
                {{ type === 'file' ? $any(item).filename : $any(item).name }}
            </p>

            <!-- Owner information -->
            @if (getOwnerInfo().username && !getOwnerInfo().isOriginal) {
            <div class="owner-info">
                <div class="owner-badge">
                    <span class="owner-icon">üë§</span>
                    <span class="owner-text">
                        Compartido por: <strong>{{ getOwnerInfo().username }}</strong>
                    </span>
                </div>
            </div>
            }

            <section class="access-section">
                <div class="access-header">
                    <h4>Usuarios con acceso</h4>
                    @if (loadingAccess()) {
                    <span class="access-status">Cargando‚Ä¶</span>
                    }
                </div>

                @if (!loadingAccess() && !hasAccessEntries()) {
                <p class="no-access">Todav√≠a no has compartido este {{ type === 'file' ? 'archivo' : 'carpeta' }}.</p>
                } @else {
                <ul class="access-list">
                    @for (access of accessList(); track access.id) {
                    <li class="access-item">
                        <div class="access-info">
                            <div class="avatar-small">{{ access.granted_to_username.charAt(0).toUpperCase() }}</div>
                            <div class="access-text">
                                <span class="access-username">{{ access.granted_to_username }}</span>
                                <!-- Dropdown para cambiar permisos -->
                                <!-- Dropdown personalizado para evitar problemas de posicionamiento nativos -->
                                <!-- Dropdown personalizado (Solo Owner) -->
                                @if (getOwnerInfo().isOriginal) {
                                <div class="custom-dropdown-container">
                                    <div class="permission-badge" [class.editable]="!isSharing()"
                                        (click)="!isSharing() && togglePermissionDropdown(access.id, $event)">
                                        {{ access.permission === 'edit' ? 'Edici√≥n' : 'Lectura' }}
                                        <span class="arrow-icon" *ngIf="!isSharing()">‚ñº</span>
                                    </div>

                                    @if (openDropdownId() === access.id) {
                                    <div class="custom-dropdown-menu">
                                        <div class="dropdown-item"
                                            (click)="onChangePermissionClick(access, 'read', $event)">
                                            Lectura
                                            @if(access.permission === 'read') { <span>‚úì</span> }
                                        </div>
                                        <div class="dropdown-item"
                                            (click)="onChangePermissionClick(access, 'edit', $event)">
                                            Edici√≥n
                                            @if(access.permission === 'edit') { <span>‚úì</span> }
                                        </div>
                                    </div>
                                    }
                                </div>
                                } @else {
                                <!-- Texto est√°tico para no-owners -->
                                <small class="access-meta">Permiso: <strong>{{ access.permission === 'edit' ? 'Edici√≥n'
                                        : 'Lectura' }}</strong></small>
                                }
                            </div>
                        </div>
                        <button class="revoke-btn icon-only" (click)="revokeAccess(access)" [disabled]="isSharing()">
                            <img src="assets/icons/boton-x.png" alt="Revocar" class="icon-close" />
                        </button>
                    </li>
                    }
                </ul>
                }
            </section>

            <section class="share-section">
                <div class="search-section">
                    <input type="text" [(ngModel)]="searchQuery" (ngModelChange)="onSearch()"
                        placeholder="Buscar usuario..." class="search-input">

                    @if (searchResults().length > 0) {
                    <div class="search-results">
                        @for (user of searchResults(); track user.id) {
                        <div class="user-item" (click)="selectUser(user)">
                            <div class="avatar">{{ user.username.charAt(0).toUpperCase() }}</div>
                            <span class="username">{{ user.username }}</span>
                        </div>
                        }
                    </div>
                    }
                </div>

                <div class="friends-section">
                    <h4>Amigos sugeridos</h4>
                    <div class="friends-list">
                        @for (friend of friends(); track friend.id) {
                        <div class="friend-chip" [class.selected]="selectedUser()?.id === friend.id"
                            (click)="selectUser(friend)">
                            <div class="avatar-small">{{ friend.username.charAt(0).toUpperCase() }}</div>
                            <span>{{ friend.username }}</span>
                        </div>
                        }
                        @if (friends().length === 0) {
                        <p class="no-friends">No tienes amigos agregados a√∫n.</p>
                        }
                    </div>
                </div>

                <div class="permission-row">
                    <label class="permission-label" for="permission-select">Permiso</label>
                    <select id="permission-select" class="permission-select" [(ngModel)]="selectedPermission">
                        <option value="read">Lectura</option>
                        <option value="edit">Edici√≥n</option>
                    </select>
                </div>

                @if (selectedUser()) {
                <div class="selected-user-summary">
                    Compartir con: <strong>{{ selectedUser().username }}</strong>
                </div>
                }
            </section>
        </div>

        <div class="modal-footer">
            <button class="cancel-btn" (click)="close.emit()">Cancelar</button>
            <button class="share-action-btn" [disabled]="!selectedUser() || isSharing()" (click)="share()">
                {{ isSharing() ? 'Guardando...' : 'Guardar acceso' }}
            </button>
        </div>
    </div>
</div>