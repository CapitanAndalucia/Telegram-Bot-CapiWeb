<div class="comp-overlay" (click)="onBackdropClick($event); closeDropdown()">
    <div class="comp-modal" [class.closing]="isClosing()">
        <div class="dialog-header">
            <h3>Compartir "{{ type === 'file' ? $any(item).filename : $any(item).name }}"</h3>
            <div class="header-actions">
                @if (viewMode() === 'invite') {
                <button class="icon-btn back-btn" (click)="cancelInvite()" title="Volver">‚Üê</button>
                }
                <button class="icon-btn close-btn" (click)="closeModal()" title="Cerrar">‚úï</button>
            </div>
        </div>

        <div class="modal-body">
            <!-- Header was here, moved up -->


            <!-- Input Area (Always visible, adapts state) -->
            <div class="share-input-area" [class.focused]="viewMode() === 'invite'" (click)="focusSearch($event)">
                <div class="chips-container">
                    @for (user of pendingInvites(); track user.id) {
                    <div class="user-chip">
                        <div class="chip-avatar">{{ user.username.charAt(0).toUpperCase() }}</div>
                        <span class="chip-name">{{ user.username }}</span>
                        <span class="chip-remove"
                            (click)="removeFromPending(user.id); $event.stopPropagation()">√ó</span>
                    </div>
                    }
                    <input #searchInput type="text" [(ngModel)]="searchQuery" (ngModelChange)="onSearch()"
                        [placeholder]="pendingInvites().length === 0 ? 'A√±adir personas, grupos y eventos...' : ''"
                        class="search-input-ghost" (focus)="onInputFocus()" />
                </div>

                @if (viewMode() === 'invite') {
                <!-- Permission Dropdown (Read/Edit) inside Input -->
                <div class="custom-dropdown-container">
                    <div class="role-trigger" (click)="toggleConfigDropdown('permission', $event)">
                        {{ inviteRole() === 'edit' ? 'Editor' : 'Lector' }}
                        <span class="arrow-icon">‚ñº</span>
                    </div>
                    @if (openConfigDropdown() === 'permission') {
                    <div class="custom-dropdown-menu shifted">
                        <div class="dropdown-item" (click)="inviteRole.set('read'); openConfigDropdown.set(null)">
                            Lector @if(inviteRole() === 'read') { <span>‚úì</span> }
                        </div>
                        <div class="dropdown-item" (click)="inviteRole.set('edit'); openConfigDropdown.set(null)">
                            Editor @if(inviteRole() === 'edit') { <span>‚úì</span> }
                        </div>
                    </div>
                    }
                </div>
                }
                @if (searchResults().length > 0) {
                <div class="search-results-dropdown">
                    @for (user of searchResults(); track user.id) {
                    <div class="result-item" (click)="selectUser(user); $event.stopPropagation()">
                        <div class="result-avatar">{{ user.username.charAt(0).toUpperCase() }}</div>
                        <div class="result-info">
                            <span class="result-name">{{ user.username }}</span>
                            <span class="result-email">{{ user.email || user.username }}</span>
                        </div>
                    </div>
                    }
                </div>
                }
            </div>


            <!-- VIEW: MAIN (Access List & General Access) -->
            @if (viewMode() === 'main') {
            <div class="main-view-content">
                <div class="section-title">Personas con acceso</div>

                <div class="access-list-scroll">
                    <!-- Owner Item -->
                    @if (getOwnerInfo().username) {
                    <div class="access-row">
                        <div class="row-avatar">{{ getOwnerInfo().username.charAt(0).toUpperCase() }}</div>
                        <div class="row-info">
                            <div class="row-name">
                                {{ getOwnerInfo().username }}
                                @if (getOwnerInfo().isOriginal) { (t√∫) }
                            </div>
                            <div class="row-email">{{ getOwnerInfo().email || 'Propietario' }}</div>
                        </div>
                        <div class="row-role owner-role">Propietario</div>
                    </div>
                    }

                    <!-- Other Access Items -->
                    @for (access of accessList(); track access.id) {
                    <div class="access-row">
                        <div class="row-avatar">{{ access.granted_to_username.charAt(0).toUpperCase() }}</div>
                        <div class="row-info">
                            <div class="row-name">{{ access.granted_to_username }}</div>
                            <div class="row-email">Usuario</div>
                        </div>

                        <!-- Role Dropdown for User -->
                        @if (getOwnerInfo().isOriginal) {
                        <div class="row-role-action">
                            <div class="custom-dropdown-container">
                                <div class="role-trigger" (click)="togglePermissionDropdown(access.id, $event)">
                                    {{ access.permission === 'edit' ? 'Editor' : 'Lector' }}
                                    <span class="arrow-icon">‚ñº</span>
                                </div>
                                @if (openDropdownId() === access.id) {
                                <div class="custom-dropdown-menu right-aligned">
                                    <div class="dropdown-item"
                                        (click)="onChangePermissionClick(access, 'read', $event)">
                                        Lector @if(access.permission === 'read') { <span>‚úì</span> }
                                    </div>
                                    <div class="dropdown-item"
                                        (click)="onChangePermissionClick(access, 'edit', $event)">
                                        Editor @if(access.permission === 'edit') { <span>‚úì</span> }
                                    </div>
                                    <div class="dropdown-separator"></div>
                                    <div class="dropdown-item danger" (click)="revokeAccess(access)">
                                        Quitar acceso
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                        } @else {
                        <div class="row-role">{{ access.permission === 'edit' ? 'Editor' : 'Lector' }}</div>
                        }
                    </div>
                    }
                </div>

                <div class="general-access-section">
                    <div class="section-title">Acceso general</div>
                    <div class="access-row general-access-row">
                        <div class="row-avatar icon-avatar">
                            @if (shareLinks().length > 0 && shareLinks()[0].access_type === 'anyone') { üåê } @else { üîí
                            }
                        </div>
                        <div class="row-info">
                            <div class="custom-dropdown-container">
                                <div class="access-trigger" (click)="toggleConfigDropdown('access', $event)">
                                    {{ (shareLinks().length > 0 && shareLinks()[0].access_type === 'anyone') ?
                                    'Cualquiera con el enlace' : 'Restringido' }}
                                    <span class="arrow-icon">‚ñº</span>
                                </div>

                                @if (openConfigDropdown() === 'access') {
                                <div class="custom-dropdown-menu">
                                    <div class="dropdown-item" (click)="createOrUpdatePublicLink('restricted')">
                                        Restringido @if(!hasPublicLink()) { <span>‚úì</span> }
                                    </div>
                                    <div class="dropdown-item" (click)="createOrUpdatePublicLink('anyone')">
                                        Cualquiera con el enlace @if(hasPublicLink()) { <span>‚úì</span> }
                                    </div>
                                </div>
                                }
                            </div>
                            <div class="row-desc">
                                {{ hasPublicLink() ? 'Cualquier usuario de Internet con el enlace puede verlo' : 'Solo
                                los usuarios con acceso pueden abrir este enlace' }}
                            </div>
                        </div>

                        @if (hasPublicLink()) {
                        <div class="row-role-action">
                            <div class="custom-dropdown-container">
                                <div class="role-trigger" (click)="toggleConfigDropdown('permission', $event)">
                                    {{ getPublicLinkRole() === 'edit' ? 'Editor' : 'Lector' }}
                                    <span class="arrow-icon">‚ñº</span>
                                </div>
                                @if (openConfigDropdown() === 'permission') {
                                <div class="custom-dropdown-menu right-aligned">
                                    <div class="dropdown-item" (click)="updatePublicLinkRole('read')">
                                        Lector @if(getPublicLinkRole() === 'read') { <span>‚úì</span> }
                                    </div>
                                    <div class="dropdown-item" (click)="updatePublicLinkRole('edit')">
                                        Editor @if(getPublicLinkRole() === 'edit') { <span>‚úì</span> }
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                        }
                    </div>
                </div>
            </div>

            <div class="modal-footer main-footer">
                <button class="footer-btn secondary" (click)="copyLink()">
                    <span class="icon">üîó</span> Copiar enlace
                </button>
                <button class="footer-btn primary" (click)="close.emit()">Hecho</button>
            </div>
            }

            <!-- VIEW: INVITE (Message & Send) -->
            @if (viewMode() === 'invite') {
            <div class="invite-view-content">
                <!-- Notification options removed as per request -->


                @if (type === 'folder') {
                <div class="folder-content-preview">
                    <!-- Optional: show what's inside logic -->
                </div>
                }
            </div>

            <div class="modal-footer invite-footer">
                <button class="footer-btn flat" (click)="cancelInvite()">Cancelar</button>
                <button class="footer-btn primary" (click)="share()" [disabled]="isSharing()">
                    {{ isSharing() ? 'Enviando...' : 'Enviar' }}
                </button>
            </div>
            }

        </div>
    </div>
</div>