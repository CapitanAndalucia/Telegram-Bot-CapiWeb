# Configuración de Escaneo de Malware

## Opciones de Configuración en `security_config.json`

### 1. Desactivar TODO el escaneo de malware
```json
{
  "malware_scanning": {
    "enabled": false,
    "scanner": "virustotal"
  }
}
```
**Resultado:** No se escanea ningún archivo. ⚠️ No recomendado para producción.

---

### 2. Usar VirusTotal (Recomendado para empezar)
```json
{
  "malware_scanning": {
    "enabled": true,
    "scanner": "virustotal",
    "virustotal": {
      "enabled": true,
      "max_file_size_mb": 650
    },
    "clamav": {
      "enabled": false
    }
  }
}
```
**Requisitos:**
- API Key de VirusTotal en `.env`: `VIRUSTOTAL_API_KEY=tu_key_aqui`
- Límite: 500 escaneos/día (gratis)
- Archivos hasta 650 MB

---

### 3. Usar ClamAV (Para producción con muchos archivos)
```json
{
  "malware_scanning": {
    "enabled": true,
    "scanner": "clamav",
    "virustotal": {
      "enabled": false
    },
    "clamav": {
      "enabled": true,
      "socket_path": "/var/run/clamav/clamd.ctl"
    }
  }
}
```

**Requisitos:**
```bash
# Instalar ClamAV
sudo apt update
sudo apt install clamav clamav-daemon

# Actualizar base de datos de virus
sudo freshclam

# Iniciar el servicio
sudo systemctl start clamav-daemon
sudo systemctl enable clamav-daemon

# Verificar que está corriendo
sudo systemctl status clamav-daemon
```

**Ventajas de ClamAV:**
- ✅ Sin límites de escaneos
- ✅ Funciona offline
- ✅ Gratis y open source
- ✅ Escanea archivos de cualquier tamaño

**Desventajas:**
- ❌ Requiere instalación en el servidor
- ❌ Consume recursos del servidor
- ❌ Base de datos de virus menos actualizada que VirusTotal

---

### 4. Usar ambos (Máxima seguridad)
```json
{
  "malware_scanning": {
    "enabled": true,
    "scanner": "virustotal",
    "virustotal": {
      "enabled": true,
      "max_file_size_mb": 650
    },
    "clamav": {
      "enabled": true,
      "socket_path": "/var/run/clamav/clamd.ctl"
    }
  }
}
```

**Comportamiento:**
1. Si `scanner = "virustotal"`:
   - Archivos ≤650MB → VirusTotal
   - Archivos >650MB → ClamAV (si está habilitado)
2. Si `scanner = "clamav"`:
   - Todos los archivos → ClamAV

---

## Recomendaciones por Escenario

### Desarrollo/Testing
```json
"malware_scanning": {
  "enabled": false
}
```
No pierdas tiempo escaneando durante desarrollo.

### Producción (Pocos usuarios)
```json
"malware_scanning": {
  "enabled": true,
  "scanner": "virustotal"
}
```
Usa VirusTotal gratis (500 archivos/día).

### Producción (Muchos usuarios)
```json
"malware_scanning": {
  "enabled": true,
  "scanner": "clamav"
}
```
Instala ClamAV para escaneos ilimitados.

### Máxima Seguridad
```json
"malware_scanning": {
  "enabled": true,
  "scanner": "virustotal",
  "clamav": { "enabled": true }
}
```
VirusTotal para archivos pequeños, ClamAV como fallback.

---

## Verificar que Funciona

### Test con VirusTotal
```bash
# Descargar archivo de prueba EICAR (detectado por todos los antivirus)
wget https://secure.eicar.org/eicar.com

# Intentar subirlo
# Debe ser rechazado con: "El archivo fue detectado como malware"
```

### Test con ClamAV
```bash
# Verificar que ClamAV está corriendo
clamscan --version

# Escanear un archivo manualmente
clamscan /ruta/al/archivo

# Ver logs
sudo journalctl -u clamav-daemon -f
```

---

## Cambiar Configuración Sin Reiniciar

**Nota:** Actualmente necesitas reiniciar el servidor Django para que los cambios en `security_config.json` surtan efecto.

Para aplicar cambios:
```bash
# Detener servidor
./stop-dev.sh

# Editar configuración
nano security_config.json

# Iniciar servidor
./start-dev.sh
```

---

## Troubleshooting

### "ClamAV daemon not running"
```bash
sudo systemctl start clamav-daemon
sudo systemctl status clamav-daemon
```

### "VirusTotal API key not found"
Añade a `.env`:
```
VIRUSTOTAL_API_KEY=tu_api_key_aqui
```

### "pyclamd not installed"
```bash
cd CapiWebBackend
pip install pyclamd
```

---

**Configuración Actual Recomendada:**
```json
{
  "malware_scanning": {
    "enabled": true,
    "scanner": "virustotal",
    "virustotal": {
      "enabled": true,
      "max_file_size_mb": 650
    },
    "clamav": {
      "enabled": false,
      "socket_path": "/var/run/clamav/clamd.ctl"
    }
  }
}
```

Cuando tengas la API Key de VirusTotal, simplemente añádela al `.env` y funcionará automáticamente.
